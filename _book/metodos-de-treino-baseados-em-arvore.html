<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>10&nbsp; Métodos de Treino Baseados em Árvore – APRENDIZADO DE MÁQUINA COM R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./outros-metodos.html" rel="next">
<link href="./pre-processamento.html" rel="prev">
<link href="./uff-brasao.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<script src="site_libs/viz-1.8.2/viz.js"></script>

<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">

<script src="site_libs/grViz-binding-1.0.11/grViz.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./metodos-de-treino-baseados-em-arvore.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Métodos de Treino Baseados em Árvore</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">APRENDIZADO DE MÁQUINA COM R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/CienciaDeDadosUFF/cienciadedadosuff2.github.io" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./APRENDIZADO-DE-MÁQUINA-COM-R.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bem-vindo</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introdução</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tipos-am.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tipos de Aprendizado de Máquina</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pred.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Predição</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./design-pred.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Design de predição</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./erros-amostrais.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Erros Amostrais</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./caret.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Avaliando Preditores - Introdução ao Pacote Caret</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cross-valid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Cross Validation (Validação Cruzada)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./comp-func.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Comparando Funções Preditoras</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pre-processamento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Pré-processamento</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metodos-de-treino-baseados-em-arvore.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Métodos de Treino Baseados em Árvore</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./outros-metodos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Outros Métodos de Aprendizado de Máquina</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Referências</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#árvores-de-decisão" id="toc-árvores-de-decisão" class="nav-link active" data-scroll-target="#árvores-de-decisão"><span class="header-section-number">10.1</span> Árvores de Decisão</a></li>
  <li><a href="#em-classificação" id="toc-em-classificação" class="nav-link" data-scroll-target="#em-classificação"><span class="header-section-number">10.2</span> em Classificação</a></li>
  <li><a href="#em-regressão" id="toc-em-regressão" class="nav-link" data-scroll-target="#em-regressão"><span class="header-section-number">10.3</span> Em Regressão</a>
  <ul class="collapse">
  <li><a href="#construindo-árvores-com-o-rpart-e-rpart.plot" id="toc-construindo-árvores-com-o-rpart-e-rpart.plot" class="nav-link" data-scroll-target="#construindo-árvores-com-o-rpart-e-rpart.plot"><span class="header-section-number">10.3.1</span> Construindo árvores com o <span class="red-text">rpart</span> e <span class="red-text">rpart.plot</span></a></li>
  <li><a href="#construindo-árvores-com-train" id="toc-construindo-árvores-com-train" class="nav-link" data-scroll-target="#construindo-árvores-com-train"><span class="header-section-number">10.3.2</span> Construindo árvores com <span class="red-text">train</span></a></li>
  </ul></li>
  <li><a href="#florestas-aleatórias" id="toc-florestas-aleatórias" class="nav-link" data-scroll-target="#florestas-aleatórias"><span class="header-section-number">10.4</span> Florestas Aleatórias</a>
  <ul class="collapse">
  <li><a href="#construindo-uma-floresta-com-o-randomforest" id="toc-construindo-uma-floresta-com-o-randomforest" class="nav-link" data-scroll-target="#construindo-uma-floresta-com-o-randomforest"><span class="header-section-number">10.4.1</span> Construindo uma floresta com o randomForest()</a></li>
  <li><a href="#construindo-uma-floresta-com-o-train" id="toc-construindo-uma-floresta-com-o-train" class="nav-link" data-scroll-target="#construindo-uma-floresta-com-o-train"><span class="header-section-number">10.4.2</span> Construindo uma floresta com o <span class="red-text">train()</span></a></li>
  <li><a href="#adaboost" id="toc-adaboost" class="nav-link" data-scroll-target="#adaboost"><span class="header-section-number">10.4.3</span> <em>AdaBoost</em></a></li>
  <li><a href="#adaboost-com-o-pacote-adabag" id="toc-adaboost-com-o-pacote-adabag" class="nav-link" data-scroll-target="#adaboost-com-o-pacote-adabag"><span class="header-section-number">10.4.4</span> Adaboost com o pacote <span class="red-text">adabag</span></a></li>
  <li><a href="#adaboost-com-o-train" id="toc-adaboost-com-o-train" class="nav-link" data-scroll-target="#adaboost-com-o-train"><span class="header-section-number">10.4.5</span> Adaboost com o <span class="red-text">train</span></a></li>
  </ul></li>
  <li><a href="#gradiente-boosting" id="toc-gradiente-boosting" class="nav-link" data-scroll-target="#gradiente-boosting"><span class="header-section-number">10.5</span> Gradiente Boosting</a>
  <ul class="collapse">
  <li><a href="#em-regressão-1" id="toc-em-regressão-1" class="nav-link" data-scroll-target="#em-regressão-1"><span class="header-section-number">10.5.1</span> em Regressão</a></li>
  <li><a href="#construindo-um-regressor-com-o-pacote-gbm" id="toc-construindo-um-regressor-com-o-pacote-gbm" class="nav-link" data-scroll-target="#construindo-um-regressor-com-o-pacote-gbm"><span class="header-section-number">10.5.2</span> Construindo um regressor com o pacote <strong>gbm</strong></a></li>
  <li><a href="#em-classificação-1" id="toc-em-classificação-1" class="nav-link" data-scroll-target="#em-classificação-1"><span class="header-section-number">10.5.3</span> em Classificação</a></li>
  <li><a href="#construindo-um-classificador-com-o-pacote-gbm" id="toc-construindo-um-classificador-com-o-pacote-gbm" class="nav-link" data-scroll-target="#construindo-um-classificador-com-o-pacote-gbm"><span class="header-section-number">10.5.4</span> Construindo um classificador com o pacote <span class="red-text">gbm</span></a></li>
  </ul></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">10.6</span> XGBoost</a>
  <ul class="collapse">
  <li><a href="#em-regressão-2" id="toc-em-regressão-2" class="nav-link" data-scroll-target="#em-regressão-2"><span class="header-section-number">10.6.1</span> Em Regressão</a></li>
  <li><a href="#construindo-um-regressor-com-o-pacote-xgboost" id="toc-construindo-um-regressor-com-o-pacote-xgboost" class="nav-link" data-scroll-target="#construindo-um-regressor-com-o-pacote-xgboost"><span class="header-section-number">10.6.2</span> Construindo um regressor com o pacote xgboost</a></li>
  <li><a href="#em-classificação-2" id="toc-em-classificação-2" class="nav-link" data-scroll-target="#em-classificação-2"><span class="header-section-number">10.6.3</span> Em Classificação</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/CienciaDeDadosUFF/cienciadedadosuff2.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Métodos de Treino Baseados em Árvore</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<style>
.red-text {
  color: red;
}
.blue-text {
  color: blue;
}
</style>
<p>Neste capítulo será estudado de forma mais aprofundada modelos de treinamento baseados em árvores, os quais são simples para interpretação, como: árvores de decisão e regressão, florestas aleatórias, adaboost, entre outros. O objetivo é entender o funcionamento dos mesmos, assim como os critérios que utilizam para classificarem as amostras.</p>
<p>É importante deixar claro que para utilizarmos esses métodos podemos usar tanto dados numéricos quanto categóricos. Além disso, não é necessário padronizar os dados.</p>
<section id="árvores-de-decisão" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="árvores-de-decisão"><span class="header-section-number">10.1</span> Árvores de Decisão</h2>
<p>Uma árvore de decisão, em geral, pergunta uma questão e classifica o elemento baseado na resposta. Ela utiliza os dados de cada indivíduo para criar uma regra de separação, que posteriormente será utilizada para rotular novas amostras.</p>
<p>As árvores de decisão podem ser aplicadas aos problemas de regressão e classificação. Primeiro vamos considerar os problemas de classificação, e depois passamos para a regressão.</p>
</section>
<section id="em-classificação" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="em-classificação"><span class="header-section-number">10.2</span> em Classificação</h2>
<p>Vejamos a seguir um exemplo de árvore de decisão para um problema de classificação.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ex_Arvores.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Nomenclatura</strong>:</p>
<ul>
<li><strong>Nó Raiz ou Raiz</strong>: é a variável que se encontra no topo da árvore;</li>
<li><strong>Nós Internos ou Nós</strong>: são as variáveis intermediárias, que possuem tanto setas apontandas para elas como saindo delas;</li>
<li><strong>Nós Folhas ou Nós Terminais ou Folhas</strong>: possuem apenas setas apontadas para elas. Representam a decisão final da árvore.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Nomenclatura_Arvore.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>No processo de construção de uma árvore de decisão é importante ressaltar que a separação dos dados deve envolver apenas duas respostas: “Sim” ou “Não”. Também é preciso definir a ordem das variáveis, como a variável com que se deve começar, qual deve ser a seguinte, e assim por diante. A solução para isso é obtida através do nível de <strong>impureza</strong> das variáveis.</p>
<p>Dizemos que uma variável é <strong>impura</strong> quando ela não consegue separar bem os dados em uma árvore de decisão. Para calcularmos a impureza de uma variável utilizamos o <strong>indíce Gini</strong>, que varia entre 0 (mais puro possível) e 0,5 (mais impuro possível). Primeiramente calculamos o índice Gini para cada nó da variável, e em seguida obtemos o índice Gini da variável como uma média ponderada. O índice Gini de um nó é obtido por:</p>
<p>Gini(nó) = 1 - <span class="math inline">\(p_{S}^2\)</span> - <span class="math inline">\(p_{N}^2\)</span>, onde <span class="math inline">\(p_{S^2}\)</span> é a proporção de “sim” da resposta da variável de interesse e<span class="math inline">\(p_{N}\)</span> a proporção de “não” da resposta da variável de interesse.</p>
<p>O <strong>índice Gini</strong> da variável é dado pela média do índice Gini para os nós referentes às respostas “Sim” e “Não” ponderada pela proporção dos elementos em cada nó.</p>
<p>Gini(variável) = Gini(nó<span class="math inline">\(_1\)</span>) <span class="math inline">\(\times\)</span> <span class="math inline">\(P_1\)</span> + Gini(nó<span class="math inline">\(_2\)</span>) <span class="math inline">\(\times\)</span> <span class="math inline">\(P_2\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>base <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">"SmallHeart.rds"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(base)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Sex  ChestPain       Thal HeartDisease
1   1    typical      fixed           No
2   0 nontypical     normal           No
3   1 nontypical     normal           No
4   0 nontypical     normal           No
5   1 nontypical reversable           No
6   1 nontypical reversable          Yes</code></pre>
</div>
</div>
<p>Nosso objetivo é prever se um indivíduo tem ou não uma doença cardíaca (variável “HeartDisease”), baseado nas outras variáveis. As variáveis explicativas são as seguintes:</p>
<ul>
<li>Sex: indica o sexo do indivíduo, onde “M” = Masculino e “F” = Feminino;</li>
<li>ChestPain: referente ao indivíduo sentir dor no peito, onde “typical” = típico e “nontypical” = não típico;</li>
<li>Thal: indica se o indivíduo possui Talassemia, onde “normal” = não possui, “fixed” = talassemia irreversível e “reversable” = talassemia reversível.</li>
</ul>
<p>Vamos verificar o quão bem as variáveis isoladamente são capazes de prever se o paciente possui ou não doença cardíaca. Vamos começar pela variável “Sex”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(base<span class="sc">$</span>Sex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.0000  1.0000  0.6944  1.0000  1.0000 </code></pre>
</div>
</div>
<p>Note que temos 22 indivíduos do sexo feminino e 50 indivíduos do sexo masculino. Como a resposta de um nó da árvore deve ser “Sim” ou “Não”, vamos utilizar a variável “Sex=M”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificando quantos indivíduos possuem doença cardíaca de acordo com o sexo:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>base <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Sex, HeartDisease) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   Sex [2]
    Sex HeartDisease     N
  &lt;int&gt; &lt;chr&gt;        &lt;int&gt;
1     0 No              20
2     0 Yes              2
3     1 No              36
4     1 Yes             14</code></pre>
</div>
</div>
<p>Então a variável “Sex=M” separa os pacientes da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_Sex.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que a maioria dos pacientes com doença cardíaca terminaram na folha referente ao sexo masculino, mas a maioria dos que não possuem doença também. Já podemos ter uma ideia que essa variável não é tão boa em separar os dados, mas para averiguarmos essa hipótese vamos calcular o índice gini dela.</p>
<p>Primeiramente vamos calcular o índice Gini do nó “Sex = M Sim”:</p>
<p><span class="math inline">\(Gini(Sex = M Sim)\)</span> = 1 - <span class="math inline">\(\left(\frac{14}{50}\right)^2\)</span> - <span class="math inline">\(\left(\frac{36}{50}\right)^2\)</span> = <span class="math inline">\(0,403\)</span></p>
<p>Agora vamos calcular o índice Gini do nó “Sex = M Não”:</p>
<p><span class="math inline">\(Gini(Sex = M Não)\)</span> = 1 - <span class="math inline">\(\left(\frac{2}{22}\right)^2\)</span> - <span class="math inline">\(\left(\frac{20}{22}\right)^2\)</span> = <span class="math inline">\(0,166\)</span></p>
<p>O índice Gini da variável “Sex = M” é dado pela média do índice Gini dos nós referentes às respostas “Sim” e “Não” ponderada pela frequência dos indivíduos em cada nó.</p>
<p><span class="math inline">\(Gini(Sex = M)\)</span> = <span class="math inline">\(0,403\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{50}{72}\right)\)</span> + <span class="math inline">\(0,166\)</span> <span class="math inline">\(\times\)</span> <span class="math inline">\(\left(\frac{22}{72}\right)\)</span> = <span class="math inline">\(0,331\)</span></p>
<p>Como o índice Gini da variável “Sex = M” ficou mais próximo de 0,5 do que de 0, podemos constatar que ela é uma variável com baixa pureza. Note que se tivéssemos escolhido a variável “Sex = F” o índice Gini obtido seria o mesmo, pois “Sex = F Sim” é equivalente a “Sex = M Não” e “Sex = F Não” é equivalente a “Sex = M Sim”. ou seja, as contas seriam as mesmas.</p>
<p>Agora vamos realizar o mesmo processo para a variável “ChestPain”, ou seja, vamos verificar o quão bem ela é capaz de prever se o paciente possui doença cardíaca.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>base <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ChestPain) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  ChestPain      N
  &lt;chr&gt;      &lt;int&gt;
1 nontypical    49
2 typical       23</code></pre>
</div>
</div>
<p>Note que temos 23 indivíduos que sentem dor no peito tipicamente e 49 indivíduos que não sentem tipicamente. Vamos verificar quantos deles possuem doença cardíaca:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>base <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ChestPain, HeartDisease) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   ChestPain [2]
  ChestPain  HeartDisease     N
  &lt;chr&gt;      &lt;chr&gt;        &lt;int&gt;
1 nontypical No              40
2 nontypical Yes              9
3 typical    No              16
4 typical    Yes              7</code></pre>
</div>
</div>
<p>Vamos considerar a variável “ChestPain = Typical”. Ela separa os dados da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_Chest.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que quase metade dos pacientes que possuem dor no peito têm doença cardíaca. Dos que não sentem a dor no peito, quase <span class="math inline">\(\frac{1}{4}\)</span> apenas possui a doença.</p>
<p>Vamos calcular o índice Gini do nó “ChestPain = Typical Sim”:</p>
<p><span class="math inline">\(Gini(ChestPain = Typical Sim)\)</span> = 1 -<span class="math inline">\(\left(\frac{7}{23}\right)^2\)</span> -<span class="math inline">\(\left(\frac{16}{23}\right)^2\)</span> =<span class="math inline">\(0,423\)</span></p>
<p>Agora vamos calcular o índice Gini do nó “ChestPain = Typical Não”:</p>
<p><span class="math inline">\(Gini(ChestPain = Typical Não)\)</span> = 1 -<span class="math inline">\(\left(\frac{9}{49}\right)^2\)</span> -<span class="math inline">\(\left(\frac{40}{49}\right)^2\)</span> =<span class="math inline">\(0,299\)</span></p>
<p>O índice Gini da variável “ChestPain = Typical” é dado pela média do índice Gini dos nós referentes às respostas “Sim” e “Não” ponderada pela frequência dos indivíduos em cada nó.</p>
<p><span class="math inline">\(Gini(Sex = M)\)</span> = <span class="math inline">\(0,423\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{23}{72}\right)\)</span> +<span class="math inline">\(0,299\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{49}{72}\right)\)</span> =<span class="math inline">\(0,339\)</span></p>
<p>Note que ela obteve um índice Gini um pouco maior do que a variável “Sex = M”. Isso indica que a variável “Sex = M” é mais pura do que a variável “ChestPain = Typical”.</p>
<p>Agora falta apenas obter o índice Gini da variável “Thal”. Mas diferentemente das outras 2 ela não possui apenas 2 níveis, e sim 3: “normal”, “fixed” e “reversable”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>base <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Thal) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  Thal           N
  &lt;chr&gt;      &lt;int&gt;
1 fixed          4
2 normal        52
3 reversable    16</code></pre>
</div>
</div>
<p>Nesse caso vamos ter que calcular o índice Gini para todas as combinações possíveis: “Thal = normal”, “Thal = fixed”, “Thal = reversable”, “Thal = normal ou fixed”, “Thal = normal ou reversable”, “Thal = fixed ou reversable”. Porém note que o índice Gini da variável “Thal = normal” é equivalente ao da variável “Thal = fixed ou reversable”, pois “Thal = normal Sim” é o mesmo que “Thal = fixed ou reversable Não”. Da mesma forma isso vale para as variáveis “Thal = fixed” e “Thal = normal ou reversable”, e “Thal = reversable” e “Thal = normal ou fixed”. Com isso conseguimos economizar algumas contas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>base <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Thal, HeartDisease) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   Thal [3]
  Thal       HeartDisease     N
  &lt;chr&gt;      &lt;chr&gt;        &lt;int&gt;
1 fixed      No               3
2 fixed      Yes              1
3 normal     No              44
4 normal     Yes              8
5 reversable No               9
6 reversable Yes              7</code></pre>
</div>
</div>
<p>Vamos, primeiramente, olhar para a variável “Thal = normal”. Ela separa os dados da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_Thal_normal.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que a maioria dos pacientes que possuem doença cardíaca estão no grupo dos que possuem “Thal = normal”.</p>
<p>Vamos calcular o índice Gini do nó “Thal = Normal Sim”:</p>
<p><span class="math inline">\(Gini(Thal = Normal Sim)\)</span> = 1 -<span class="math inline">\(\left(\frac{8}{52}\right)^2\)</span> -<span class="math inline">\(\left(\frac{44}{52}\right)^2\)</span> =<span class="math inline">\(0,260\)</span></p>
<p>Agora vamos calcular o índice Gini do nó “Thal = Normal Não”:</p>
<p><span class="math inline">\(Gini(Thal = Normal Não)\)</span> = 1 -<span class="math inline">\(\left(\frac{8}{20}\right)^2\)</span> -<span class="math inline">\(\left(\frac{12}{20}\right)^2\)</span> =<span class="math inline">\(0,480\)</span></p>
<p>Então o índice Gini da variável “Thal = Normal” fica da seguinte forma:</p>
<p><span class="math inline">\(Gini(Thal = Normal)\)</span> =<span class="math inline">\(0,260\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{52}{70}\right)\)</span> +<span class="math inline">\(0,480\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{20}{72}\right)\)</span> =<span class="math inline">\(0,321\)</span></p>
<p>Agora vamos olhar para a variável “Thal = Fixed”. Ela separa os dados da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_Thal_fixed.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Vamos calcular o índice Gini do nó “Thal = Fixed Sim”:</p>
<p><span class="math inline">\(Gini(Thal = Fixed Sim)\)</span> = 1 -<span class="math inline">\(\left(\frac{1}{4}\right)^2\)</span> -<span class="math inline">\(\left(\frac{3}{4}\right)^2\)</span> =<span class="math inline">\(0,375\)</span></p>
<p>Agora vamos calcular o índice Gini do nó “Thal = Fixed Não”:</p>
<p><span class="math inline">\(Gini(Thal = Fixed Não)\)</span> = 1 -<span class="math inline">\(\left(\frac{15}{68}\right)^2\)</span> -<span class="math inline">\(\left(\frac{53}{68}\right)^2\)</span> =<span class="math inline">\(0,344\)</span></p>
<p>Então o índice Gini da variável “Thal = Fixed” fica da seguinte forma:</p>
<p><span class="math inline">\(Gini(Thal = Fixed)\)</span> =<span class="math inline">\(0,375\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{4}{72}\right)\)</span> +<span class="math inline">\(0,344\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{68}{72}\right)\)</span> =<span class="math inline">\(0,346\)</span></p>
<p>Por último, vamos olhar para a variável “Thal = Reversable”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_Thal_reversable.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Vamos calcular o índice Gini do nó “Thal = Reversable Sim”:</p>
<p><span class="math inline">\(Gini(Thal = Reversable Sim)\)</span> = 1 -<span class="math inline">\(\left(\frac{7}{16}\right)^2\)</span> -<span class="math inline">\(\left(\frac{9}{16}\right)^2\)</span> =<span class="math inline">\(0,492\)</span></p>
<p>Agora vamos calcular o índice Gini do nó “Thal = Reversable Não”:</p>
<p><span class="math inline">\(Gini(Thal = Reversable Não)\)</span> = 1 -<span class="math inline">\(\left(\frac{9}{56}\right)^2\)</span> -<span class="math inline">\(\left(\frac{47}{56}\right)^2\)</span> =<span class="math inline">\(0,269\)</span></p>
<p>Então o índice Gini da variável “Thal = Reversable” fica da seguinte forma:</p>
<p><span class="math inline">\(Gini(Thal = Reversable)\)</span> =<span class="math inline">\(0,492\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{16}{72}\right)\)</span> +<span class="math inline">\(0,269\)</span><span class="math inline">\(\times\)</span><span class="math inline">\(\left(\frac{56}{72}\right)\)</span> =<span class="math inline">\(0,319\)</span></p>
<p>Resumindo, os índices Ginis de todas as variáveis são:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Variáveis</strong></th>
<th><strong>Índice Gini</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sex = M</td>
<td>0,331</td>
</tr>
<tr class="even">
<td>ChestPain = Typical</td>
<td>0,339</td>
</tr>
<tr class="odd">
<td>Thal = Normal</td>
<td>0,321</td>
</tr>
<tr class="even">
<td>Thal = Fixed</td>
<td>0,346</td>
</tr>
<tr class="odd">
<td>Thal = Reversable</td>
<td>0,319</td>
</tr>
</tbody>
</table>
<p>A variável “Thal = Reversable” é a que possui o menor índice Gini, portanto ela é a mais pura. Ela ficará no topo da árvore de decisão, ou seja, será o nó raiz.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Raiz_Arvore_Final.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>O próximo passo é definir as variáveis que ficarão no nó “Thal = Reversable Sim” e “Thal = Reversable Não”. Para isso temos que olhar para a base de dados com os indivíduos do grupo “Thal = Reversable Sim” e “Thal = Reversable Não”, respectivamente.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grupo de indivíduos "Thal = Reversable Sim":</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>base1 <span class="ot">=</span> base <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Thal <span class="sc">==</span> <span class="st">"reversable"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(base1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Sex  ChestPain       Thal HeartDisease
1   1 nontypical reversable           No
2   1 nontypical reversable          Yes
3   1    typical reversable           No
4   1 nontypical reversable           No
5   1 nontypical reversable          Yes
6   1    typical reversable          Yes</code></pre>
</div>
</div>
<p>Agora temos que calcular o índice Gini para todas as variáveis referentes a esse grupo. A que for mais pura entrará no nó “Thal = Reversable Sim”. Poupando os cálculos, vamos obter que o menor índice Gini é o da variável “ChestPain = Typical”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grupo de indivíduos "Thal = Reversable Não":</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>base2 <span class="ot">=</span> base <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Thal <span class="sc">!=</span> <span class="st">"reversable"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(base2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Sex  ChestPain   Thal HeartDisease
1   1    typical  fixed           No
2   0 nontypical normal           No
3   1 nontypical normal           No
4   0 nontypical normal           No
5   1 nontypical normal           No
6   1    typical normal           No</code></pre>
</div>
</div>
<p>Agora calculamos também o índice Gini para todas as variáveis referentes a esse grupo. Após os cálculos necessários veremos que o menor índice Gini é o da variável “ChestPain = Nontypical”.</p>
<p>Dessa forma, podemos dar continuidade a nossa árvore.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arvore_de_Decisao_Final.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Após obtidos esses novos nós, o processo continua se repetindo, obtendo novos nós e/ou folhas para a árvore, até a construção chegar ao fim.</p>
<p>Pergunta: quando o processo de construção de uma árvore chega ao fim? O processo de construção pode terminar por 3 fatores:</p>
<ul>
<li>Quando a pureza do nó é maior do que o de qualquer variável que adicionamos;</li>
<li>Quando atingimos folhas 100% puras (índice Gini = 0);</li>
<li>Quando o ganho ao aumentar a árvore é muito pequeno.</li>
</ul>
<p>O ganho ao aumentar a árvore pode ser resumido como um conjunto de atributos presentes na árvore que retornem o maior ganho de informações. Essa questão será melhor abordada posteriormente, juntamente com a questão de como podar as árvores (que está intimamente relacionada ao ganho) no subcapítulo <strong>XGBoost</strong>.</p>
</section>
<section id="em-regressão" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="em-regressão"><span class="header-section-number">10.3</span> Em Regressão</h2>
<p>Agora iremos discutir o processo de construção de uma árvore de regressão. Em uma árvore de regressão, diferentemente de uma árvore para classificação, cada folha possui um valor numérico (ao invés de categorias como “Sim” ou “Não”, como no exemplo anterior da base SmallHeart). Vejamos a seguir um exemplo de árvore de decisão para um problema de regressão.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ex_Arvore_Reg-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Esse valor numérico presente nas folhas não é nada menos que a média do valor da variável de interesse a ser prevista para os elementos que satisfazem a condição do nó. Por exemplo, na árvore de regressão acima a primeira folha dá como resultado uma eficácia de 5%: essa foi a média observada da eficácia do medicamento em pacientes com mais de 50 anos de idade. Para a segunda folha, a com eficácia de 20%: esse valor é a média da eficácia do medicamento em um indivíduo com menos de 50 anos de idade e que toma uma dosagem maior do que 29mg foi de 20%. O processo é o mesmo para as outras folhas.</p>
<p>A grande pergunta é qual valor colocar no nó como condição. Para exemplificar como funciona o processo, vamos começar com um exemplo simples:</p>
<p><strong>Ex.:</strong> Vamos carregar o banco de dados “SmallAdvertising”. Este banco possui informações sobre as vendas de um produto em 10 mercados diferentes (variável sales), além de orçamentos de publicidade para esse produto em cada um dos mercados para três mídias diferentes: TV, rádio e jornal (variáveis TV, radio e newspaper, respectivamente).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>vendas <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">"SmallAdvertising.rds"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>vendas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      TV radio newspaper sales
1  200.0   2.6      21.2  10.6
2   66.1   5.8      24.2   8.6
3  215.0  24.0       4.0  17.4
4   23.8  35.1      65.9   9.2
5   97.5   7.6       7.2   9.7
6  204.0  32.9      46.0  19.0
7  195.0  47.7      52.9  22.4
8   67.8  36.6     114.0  12.5
9  281.0  39.6      55.8  24.4
10  69.2  20.5      18.3  11.3
11 147.0  23.9      19.1  14.6</code></pre>
</div>
</div>
<p>Vamos considerar o caso em que queremos construir uma árvore de regressão para prever as vendas baseados apenas na variável TV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vendas<span class="sc">$</span>TV, vendas<span class="sc">$</span>sales, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Orçamento de Publicidade do Produto para a TV"</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Vendas do Produto"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Vendas do produto x Publicidade para a TV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Primeiramente é preciso definir qual valor irá entrar como condição no primeiro nó. O algoritmo realiza isso testando todos os possíveis valores de separação para os dados, e pega o que minimiza a soma dos quadrados dos resíduos. Inicialmente, como o primeiro separador, ele considera a média dos 2 menores valores da Publicidade.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ordenados <span class="ot">=</span> <span class="fu">sort</span>(vendas<span class="sc">$</span>TV)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(ordenados[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44.95</code></pre>
</div>
</div>
<p>Então 44,95 é o primeiro valor a ser testado para a separação dos dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vendas<span class="sc">$</span>TV, vendas<span class="sc">$</span>sales, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Orçamento de Publicidade do Produto para a TV"</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Vendas do Produto"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Vendas do produto x Publicidade para a TV"</span>); <span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">44.95</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Assim, o primeiro nó será da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ArvReg1-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Para a resposta “sim” prevemos que as vendas do produto será de 9,2, o qual é o resultado da média dos valores das vendas para todos os produtos cuja publicidade foi menor do que 44,95 (ou seja, é apenas o valor do primeiro elemento). Para a resposta “Não”, então a folha seguinte contém o resultado da média dos valores das vendas para todos os produtos cuja publicidade foi maior do que 44,95, o qual é de 15,05.</p>
<p>Note que fazendo isso teremos resíduos (diferença do valor original e do valor predito pela árvore) muito grandes. O algoritmo eleva esses resíduos ao quadrado e os soma. Esse valor é a soma dos quadrados dos resíduos considerando o nó “Publicidade para a TV &lt; 44,95?”.</p>
<p>Em seguida ele irá para o próximo separador: a média do segundo e do terceiro menores pontos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(ordenados[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 66.95</code></pre>
</div>
</div>
<p>Então 66,95 é o segundo valor a ser testado para a separação dos dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vendas<span class="sc">$</span>TV, vendas<span class="sc">$</span>sales, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Orçamento de Publicidade do Produto para a TV"</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Vendas do Produto"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Vendas do produto x Publicidade para a TV"</span>); <span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">66.95</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Então o nó considerado será da forma “Publicidade para a TV &lt; 66,95?”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ArvReg2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>O valor de 8,9 corresponde ao resultado da média dos valores das vendas para todos os produtos cuja publicidade foi menor do que 66,95. Então a árvore prevê esse valor de vendas para o produto que obteve uma publicidade para a TV &lt; 66,95. O valor de 15,77 é o resultado da média dos valores das vendas para todos os produtos cuja publicidade foi maior do que 66,95. Novamente serão obtidos os resíduos dessa predição e eles serão somados.</p>
<p>Então o algoritmo irá para o próximo separador e irá calcular a soma dos quadrados dos resíduos da predição. Isso ocorre sucessivamente até acabarem todos os separadores possíveis para a árvore. O separador vencedor (aquele que irá para o nó raiz) é aquele com a menor soma dos quadrados dos resíduos.</p>
<p>A construção dos próximos nós se dá pela mesma forma que a do nó raiz. O processo de construção da árvore termina quando:</p>
<ul>
<li><p>Atingimos um número mínimo de observações em uma folha (usualmente é utilizado 20 observações). Não continuamos a divisão após esse número mínimo pois corremos o risco de criar uma árvore sobreajustada à amostra dada;</p></li>
<li><p>Quando o ganho ao aumentar a árvore é muito pequeno.</p></li>
</ul>
<p>Agora vamos para o caso em que tenhamos mais de uma variável preditiva nos dados. Vamos considerar agora que queremos prever as vendas do produto baseado em seus orçamentos de publicidade para TV, rádio e jornal.</p>
<p>Assim como anteriormente, começamos usando o orçamento para a TV para prever as vendas, e pegamos o separador com a menor soma dos quadrados dos resíduos. O melhor separador se torna um candidato para a raiz da árvore. Em seguida, focamos em utilizar o orçamento para o rádio para prever as vendas. Assim como com o orçamento para a TV, tentamos diferentes separadores para a predição e calculamos a soma dos quadrados dos resíduos em cada passo. O melhor separador se torna outro candidato para a raiz. Por último, utilizamos o orçamento para o jornal para prever as vendas, e após tentarmos diferentes separadores pegamos aquele com a menor soma dos quadrados dos resíduos também. Então comparamos a soma dos quadrados dos resíduos de todos os candidatos para a raiz, e o escolhido, novamente, é aquele com a menor soma.</p>
<p>Para os próximos nós o processo de construção também é equivalente ao anterior, exceto que agora nós comparamos a menor soma dos quadrados dos resíduos de cada preditor. E, novamente, quando uma folha atinge um número mínimo de observações, a árvore é finalizada.</p>
<section id="construindo-árvores-com-o-rpart-e-rpart.plot" class="level3" data-number="10.3.1">
<h3 data-number="10.3.1" class="anchored" data-anchor-id="construindo-árvores-com-o-rpart-e-rpart.plot"><span class="header-section-number">10.3.1</span> Construindo árvores com o <span class="red-text">rpart</span> e <span class="red-text">rpart.plot</span></h3>
<p>Vamos construir árvores com o comando rpart(). Como argumento da função nós passamos:</p>
<ul>
<li>A variável de interesse a ser prevista em função das variáveis preditoras;</li>
<li>A base de dados onde as variáveis se encontram.</li>
</ul>
<p>Vamos utilizar a base de dados referentes ao primeiro exemplo dado de construção de uma árvore, onde queríamos prever se um indivíduo possui doença cardíaca baseado em características dele.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>heart_arvore <span class="ot">=</span> <span class="fu">rpart</span>(HeartDisease<span class="sc">~</span>., <span class="at">data =</span> base)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora vamos plotar a árvore com o comando rpart.plot().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(heart_arvore)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Observe que a árvore ficou “vazia”. O que ela quer dizer com isso é: assuma “Não” sempre para o indivíduo possuir doença cardíaca, e acerte com precisão de 78%. Isso ocorre devido aos valores iniciais do comando rpart.control(), que ajusta os parâmetros da função rpart(). Os principais parâmetros do rpart.control são:</p>
<ul>
<li><p>minsplit: o número mínimo de observações que devem existir em um nó para que uma divisão seja tentada. Padrão: minsplit = 20;</p></li>
<li><p>minbucket: o número mínimo de observações em qualquer folha. Padrão: minbucket = minsplit/3;</p></li>
<li><p>cp (complexity parameter): o mínimo de ganho de ajuste que devemos ter em cada divisão. O principal papel desse parâmetro é economizar tempo de computação removendo as divisões que não valem a pena. Padrão: cp = 0,01;</p></li>
<li><p>maxdepth: profundidade máxima da árvore (a profundidade da raiz é zero). Não pode ser maior que 30.</p></li>
</ul>
<p><strong>Ex. 1:</strong> Vamos ajustar os parâmetros da árvore e construí-la novamente. Vamos determinar que a profundidade da árvore seja 2, que 0 seja o número mínimo de observações em um nó e que ela seja construída mesmo que não haja ganhos em mais divisões.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">rpart.control</span>(<span class="at">minsplit=</span><span class="dv">0</span>, <span class="at">cp =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">maxdepth =</span> <span class="dv">2</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>heart_arvore <span class="ot">=</span> <span class="fu">rpart</span>(HeartDisease<span class="sc">~</span>., <span class="at">data =</span> base, <span class="at">control =</span> controle)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(heart_arvore)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note que o nó raiz é exatamente aquele que calculamos como o mais puro, o “Thal = Reversable”, que é equivalente a “Thal = Fixed ou Normal”. Os nós adjacentes também foram o que obtivemos anteriormente como os mais puros.</p>
<p>Cada saída do comando rpart.plot() tem um significado específico:</p>
<ol type="1">
<li>A primeira saída é a classe estimada pela árvore para as amostras que se encontram naquele nó.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rpart1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ol start="2" type="1">
<li><p>A segunda saída é a proporção de indivíduos na classe contrária àquela estimada na primeira saída.</p></li>
<li><p>A terceira saída é a porcentagem da amostra que se encontra no atual nó.</p></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rpart3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Ex. 2:</strong> Vamos agora constuir a árvore mais completa possível, ou seja, uma árvore sobreajustada à amostra, sem restrições em sua profundidade máxima.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">rpart.control</span>(<span class="at">minsplit=</span><span class="dv">0</span>, <span class="at">cp =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>heart_arvore <span class="ot">=</span> <span class="fu">rpart</span>(HeartDisease<span class="sc">~</span>., <span class="at">data =</span> base, <span class="at">control =</span> controle)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(heart_arvore)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Ex. 3:</strong> Vamos agora considerar 10 como o número mínimo de observações em um nó e 3 como a profundidade máxima da árvore.</p>
<p>Agora podemos levantar a seguinte questão: como avaliar a precisão do modelo construído? Nesse exemplo nós utilizamos toda a amostra para construir a árvore, apenas para explicar o funcionamente do <span class="red-text">rpart</span>, então não temos uma amostra teste para verificar o quão bom é o modelo. Então para isso teríamos que primeiramente dividir a amostra em treino e teste, depois criar o modelo com a amostra treino e em seguida aplicá-lo na amostra teste, e então, por último, poderíamos utilizar a função confusionMatrix() para obtermos não só a precisão como outras medidas avaliativas do modelo, além, é claro, da matriz de confusão. No tópico abaixo essas etapas serão construídas detalhadamente.</p>
</section>
<section id="construindo-árvores-com-train" class="level3" data-number="10.3.2">
<h3 data-number="10.3.2" class="anchored" data-anchor-id="construindo-árvores-com-train"><span class="header-section-number">10.3.2</span> Construindo árvores com <span class="red-text">train</span></h3>
<p>Podemos utilizar árvores de decisão/regressão como um método de treinamento para os dados através da função train(). Vamos fazer isso utilizando a base de dados College. Este banco possui informações sobre 777 diferentes universidades e faculdades dos EUA. Ela apresenta algumas variáveis como: Apps - número de pedidos recebidos para ingresso, Room.Board - custos de acomodação e alimentação, Books - custos estimados de livros, PhD - quantidade de professores com doutorado, entre outras, e nossa variável de interesse Private, que indica se a universidade é privada ou pública.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>college <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"College.csv"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>college <span class="ot">=</span> college[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(college)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 18
  Private  Apps Accept Enroll Top10perc Top25perc F.Undergrad P.Undergrad
  &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1 Yes      1660   1232    721        23        52        2885         537
2 Yes      2186   1924    512        16        29        2683        1227
3 Yes      1428   1097    336        22        50        1036          99
4 Yes       417    349    137        60        89         510          63
5 Yes       193    146     55        16        44         249         869
6 Yes       587    479    158        38        62         678          41
# ℹ 10 more variables: Outstate &lt;dbl&gt;, Room.Board &lt;dbl&gt;, Books &lt;dbl&gt;,
#   Personal &lt;dbl&gt;, PhD &lt;dbl&gt;, Terminal &lt;dbl&gt;, S.F.Ratio &lt;dbl&gt;,
#   perc.alumni &lt;dbl&gt;, Expend &lt;dbl&gt;, Grad.Rate &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Vamos, primeiramente, separar a amostra em treino e teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(<span class="at">y =</span> college<span class="sc">$</span>Private, <span class="at">p =</span> <span class="fl">0.7</span>, <span class="at">list =</span> F)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> college[noTreino,]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> college[<span class="sc">-</span>noTreino,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Vamos treinar o modelo pelo método de árvores de decisão. Fazemos isso através do argumento “method = rpart” da função train().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(Private<span class="sc">~</span>., <span class="at">method =</span> <span class="st">"rpart"</span>, <span class="at">data =</span> treino)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CART 

545 samples
 17 predictor
  2 classes: 'No', 'Yes' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 545, 545, 545, 545, 545, 545, ... 
Resampling results across tuning parameters:

  cp          Accuracy   Kappa    
  0.04362416  0.9081649  0.7588635
  0.20134228  0.8721337  0.6609327
  0.51006711  0.8325440  0.5238781

Accuracy was used to select the optimal model using the largest value.
The final value used for the model was cp = 0.04362416.</code></pre>
</div>
</div>
<p>Observe que através do train() são testados alguns valores para o cp (complexity parameter) e é eleito aquele com a maior taxa de acurácia. Nesse caso, o cp utilizado será o de aproximadamente 0,0436. Vamos aplicar o modelo no conjunto teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformando em fator para depois construirmos a matriz de confusão:</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>teste<span class="sc">$</span>Private <span class="ot">=</span> <span class="fu">as.factor</span>(teste<span class="sc">$</span>Private)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Avaliando o modelo utilizando a matriz de confusão:</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(predicao, teste<span class="sc">$</span>Private)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  No Yes
       No   44   6
       Yes  19 163
                                        
               Accuracy : 0.8922        
                 95% CI : (0.845, 0.929)
    No Information Rate : 0.7284        
    P-Value [Acc &gt; NIR] : 7.796e-10     
                                        
                  Kappa : 0.7088        
                                        
 Mcnemar's Test P-Value : 0.0164        
                                        
            Sensitivity : 0.6984        
            Specificity : 0.9645        
         Pos Pred Value : 0.8800        
         Neg Pred Value : 0.8956        
             Prevalence : 0.2716        
         Detection Rate : 0.1897        
   Detection Prevalence : 0.2155        
      Balanced Accuracy : 0.8315        
                                        
       'Positive' Class : No            
                                        </code></pre>
</div>
</div>
<p>Obtivemos uma acurácia de 0,8922, o que é razoável para um modelo que utiliza árvores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Desenhando a árvore:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(modelo<span class="sc">$</span>finalModel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A limitação de utilizar as árvores através do train() é que o único parâmetro da árvore que pode ser alterado é o cp (*complexity parameter).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modelLookup</span>(<span class="st">"rpart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model parameter                label forReg forClass probModel
1 rpart        cp Complexity Parameter   TRUE     TRUE      TRUE</code></pre>
</div>
</div>
<p>Para alterarmos o seu valor utilizamos o comando expand.grid().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">.cp =</span> <span class="fl">0.0001</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(Private<span class="sc">~</span>., <span class="at">method =</span> <span class="st">"rpart"</span>, <span class="at">data =</span> treino, <span class="at">tuneGrid =</span> controle)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CART 

545 samples
 17 predictor
  2 classes: 'No', 'Yes' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 545, 545, 545, 545, 545, 545, ... 
Resampling results:

  Accuracy   Kappa    
  0.9108212  0.7723318

Tuning parameter 'cp' was held constant at a value of 1e-04</code></pre>
</div>
</div>
<p>Note que com esse valor de cp a árvore fica mais profunda, pois estamos diminuindo o mínimo de ganho de ajuste que devemos ter em cada divisão.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(modelo<span class="sc">$</span>finalModel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="florestas-aleatórias" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="florestas-aleatórias"><span class="header-section-number">10.4</span> Florestas Aleatórias</h2>
<p>As árvores de decisão possuem uma estrutura de fácil compreensão, o que faz com que ela seja bastante utilizada devido a sua boa aparência e interpretação intuitíva. Mas elas possuem uma limitação, o <strong>sobreajuste</strong>, sendo assim, elas não são muito eficientes com novas amostras. O que fazer então?</p>
<p>As <strong>Florestas Aleatórias</strong> (<em>Random Forest</em>) se utilizam de várias árvores de decisão, combinando a simplicidade das árvores com a flexibilidade de um método sem sobreajuste, aumentando assim a precisão do preditor.</p>
<p>Vamos construir uma floresta aleatória usando a base de dados <span class="red-text">balloons</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"balloons.csv"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>balloons<span class="sc">$</span>inflated <span class="ot">=</span> <span class="fu">as.factor</span>(balloons<span class="sc">$</span>inflated)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(balloons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>spc_tbl_ [100 × 5] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
 $ color   : chr [1:100] "YELLOW" "YELLOW" "YELLOW" "YELLOW" ...
 $ size    : chr [1:100] "SMALL" "SMALL" "SMALL" NA ...
 $ act     : chr [1:100] "STRETCH" "STRETCH" "STRETCH" "STRETCH" ...
 $ age     : chr [1:100] "ADULT" "ADULT" "ADULT" "ADULT" ...
 $ inflated: Factor w/ 2 levels "FALSE","TRUE": 2 2 2 2 2 2 2 2 2 2 ...
 - attr(*, "spec")=
  .. cols(
  ..   color = col_character(),
  ..   size = col_character(),
  ..   act = col_character(),
  ..   age = col_character(),
  ..   inflated = col_logical()
  .. )
 - attr(*, "problems")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<p>Com base na cor do balão, o tamanho dele, se ele é elástico ou não e se quem o está enchendo é uma criança ou um adulto, queremos predizer se o balão vai encher ou não. Portanto, nossa variável de interesse é <span class="red-text">Inflated</span> e queremos construir um classificador.</p>
<p>A primeira coisa que precisamos fazer é criar uma nova amostra do mesmo tamanho da original utilizando <strong>bootstrap</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">33</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>boot1 <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">createResample</span>(<span class="at">y=</span>balloons<span class="sc">$</span>inflated, <span class="at">times=</span><span class="dv">1</span>, <span class="at">list=</span>F)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>NovaAmostra1 <span class="ot">=</span> balloons[boot1,]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>Out_of_bag <span class="ot">=</span> balloons[<span class="sc">-</span>boot1,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Todas as observações que não forem sorteadas vão entrar no “Out-of-Bag”. Temos 4 variáveis fora a de interesse, vamos sortear 2 variáveis para construir o primeiro nó da nossa árvore.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">413</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4 3</code></pre>
</div>
</div>
<p>Vamos calcular o índice Gini para essas duas variáveis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculando o indice gini para a variável tamanho</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(NovaAmostra1<span class="sc">$</span>size, NovaAmostra1<span class="sc">$</span>inflated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
        FALSE TRUE
  LARGE    29   18
  SMALL    28   22</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">gini.size =</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">7</span><span class="sc">/</span><span class="dv">14</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">7</span><span class="sc">/</span><span class="dv">14</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">14</span><span class="sc">/</span><span class="dv">20</span>) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">4</span><span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">6</span><span class="sc">/</span><span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4833333</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculando o indice gini para a variável idade</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(NovaAmostra1<span class="sc">$</span>age, NovaAmostra1<span class="sc">$</span>inflated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
        FALSE TRUE
  ADULT    26   43
  C         3    0
  CHILD    28    0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">gini.age =</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">5</span><span class="sc">/</span><span class="dv">14</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">9</span><span class="sc">/</span><span class="dv">14</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">14</span><span class="sc">/</span><span class="dv">20</span>) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">6</span><span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">0</span><span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">6</span><span class="sc">/</span><span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3214286</code></pre>
</div>
</div>
<p>A variável idade tem um grau de impureza menor, então ela será a raiz da árvore.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/floresta1.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora das variáveis que ainda não foram usadas, sorteamos mais duas para continuar a árvore.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">443</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 2</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>NovaAmostra1 <span class="ot">=</span> <span class="fu">filter</span>(NovaAmostra1, age<span class="sc">==</span><span class="st">"ADULT"</span>) </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">#calculando o indice gini para a variável tamanho</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(NovaAmostra1<span class="sc">$</span>size, NovaAmostra1<span class="sc">$</span>inflated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
        FALSE TRUE
  LARGE    15   18
  SMALL    11   22</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">gini.size =</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">4</span><span class="sc">/</span><span class="dv">11</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">7</span><span class="sc">/</span><span class="dv">11</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">11</span><span class="sc">/</span><span class="dv">14</span>) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">3</span><span class="sc">/</span><span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4588745</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculando o indice gini para a variável act</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(NovaAmostra1<span class="sc">$</span>act, NovaAmostra1<span class="sc">$</span>inflated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         
          FALSE TRUE
  DIP        26    0
  STRETCH     0   43</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">gini.act =</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">5</span><span class="sc">/</span><span class="dv">5</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">0</span><span class="sc">/</span><span class="dv">5</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">5</span><span class="sc">/</span><span class="dv">14</span>) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>(<span class="dv">0</span><span class="sc">/</span><span class="dv">9</span>)<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>(<span class="dv">9</span><span class="sc">/</span><span class="dv">9</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">9</span><span class="sc">/</span><span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>Como a variável act tem o menor grau de impureza, ela será o próximo nó.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/floresta2.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Assim, temos nossa primeira árvore de decisão.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/floresta3.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>A floresta aleatória pode ser utilizada tanto em classificadores como em regressores. A diferença é que em regressores, utilizamos árvores de regressão no lugar de árvores de classificação.</p>
<p>Em seguida vamos construir várias árvores da mesma maneira que a anterior. Para nosso exemplo vamos construir apenas 4 árvores, mas em geral vamos fazer bem mais que isso.</p>
<p>Temos então nossas 4 árvores construidas.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/floresta4.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/floresta5.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Para classificar uma nova amostra, devemos passar ela por todas as árvores construidas e rotular a amostra pela categoria resultada mais vezes.</p>
<p>O método de usar bootstrap para criar novas amostras e votos para a tomada de decisão é chamado de <strong>Bagging</strong> (<em>B</em>ootstrap+<strong>agg</strong>regate).</p>
<p>As observações de cada amostra que não entraram na construção de cada árvore estão contidas <span class="red-text">Out of Bag</span>. Essas observações servirão para avaliar nosso preditor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>Out_of_bag <span class="ot">=</span> balloons[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">15</span>,<span class="dv">18</span>,<span class="dv">20</span>,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">10</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">15</span>,<span class="dv">18</span>,<span class="dv">20</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">11</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">16</span>,<span class="dv">19</span>),]</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Out_of_bag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">color</th>
<th style="text-align: left;">size</th>
<th style="text-align: left;">act</th>
<th style="text-align: left;">age</th>
<th style="text-align: left;">inflated</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">STRETCH</td>
<td style="text-align: left;">CHILD</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">YELLOW</td>
<td style="text-align: left;">SMALL</td>
<td style="text-align: left;">DIP</td>
<td style="text-align: left;">ADULT</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Para avaliar, é preciso passar cada uma das observações do <span class="red-text">Out of Bag</span> por todas as árvores e a predição será feita por votos também. Ao fazer isso, observamos uma precisão de 86%.</p>
<p>A proporção de amostras do Out-of-bag que foram incorretamente classificadas é chamada <em>Out-of-bag-error</em></p>
<p>Agora que sabemos avaliar o modelo, podemos comparar florestas aleatórias construídas com 2 variáveis com as construídas com 3 e outras diferentes configurações. Tipicamente, começamos usando o quadrado do número de variáveis da base e tentamos algumas quantidades abaixo e acima.</p>
<section id="construindo-uma-floresta-com-o-randomforest" class="level3" data-number="10.4.1">
<h3 data-number="10.4.1" class="anchored" data-anchor-id="construindo-uma-floresta-com-o-randomforest"><span class="header-section-number">10.4.1</span> Construindo uma floresta com o randomForest()</h3>
<p>O pacote <strong>randomForest</strong> possui as ferramentas adequadas para a criação de uma floresta aleatória. Vamos construir uma floresta com 20 árvores utilizando a base <span class="red-text">balloons</span>.</p>
<p>É importante observar se as váriaveis categóricas estão na classe de fatores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"balloons.csv"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> <span class="fu">na.omit</span>(balloons)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tratando todas as variaveis </span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">mutate_if</span>(balloons, is.character, as.factor)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>balloons<span class="sc">$</span>inflated <span class="ot">=</span> <span class="fu">as.factor</span>(balloons<span class="sc">$</span>inflated)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo floresta com 20 arvores</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">randomForest</span>(inflated <span class="sc">~</span> ., <span class="at">data=</span>balloons, <span class="at">ntree=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora, vamos avaliar a precisão do modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># avaliando o modelo</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = inflated ~ ., data = balloons, ntree = 20) 
               Type of random forest: classification
                     Number of trees: 20
No. of variables tried at each split: 2

        OOB estimate of  error rate: 0%
Confusion matrix:
      FALSE TRUE class.error
FALSE    59    0           0
TRUE      0   38           0</code></pre>
</div>
</div>
<p>Note que foram construídas 20 árvores utilizando 2 variáveis a cada vez. Essa quantidade de variáveis pode ser alterada usando o argumento <strong>mtry=</strong> dentro do randomForest.</p>
<p>Podemos ver que a precisão do nosso modelo é de 19/20, ou seja, 95%. Qual seria a precisão se fosse feito apenas uma árvore?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"balloons.csv"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tratando todas as variaveis </span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>balloons <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">mutate_if</span>(balloons, is.character, as.factor)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>balloons<span class="sc">$</span>inflated <span class="ot">=</span> <span class="fu">as.factor</span>(balloons<span class="sc">$</span>inflated)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># separando amostras teste/treino</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">45</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>inTrain <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">createDataPartition</span>(balloons<span class="sc">$</span>inflated,<span class="at">p=</span><span class="fl">0.5</span>,<span class="at">list=</span>F)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> balloons[inTrain,]</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> balloons[<span class="sc">-</span>inTrain,]</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># treinando o modelo</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> rpart<span class="sc">::</span><span class="fu">rpart.control</span>(<span class="at">minsplit=</span><span class="dv">0</span>, <span class="at">cp =</span> <span class="dv">0</span>, <span class="at">maxdepth =</span> <span class="dv">1</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">342</span>)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> rpart<span class="sc">::</span><span class="fu">rpart</span>(inflated<span class="sc">~</span>., <span class="at">data=</span>treino, <span class="at">control =</span> controle)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="co"># aplicando o modelo no teste</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo,teste, <span class="at">type=</span><span class="st">"vector"</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">factor</span>(predicao, <span class="at">labels =</span> <span class="fu">c</span>(F, T))</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co"># avaliando o erro na amostra treino</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(teste<span class="sc">$</span>inflated, predicao)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE    17   13
     TRUE      0   20
                                          
               Accuracy : 0.74            
                 95% CI : (0.5966, 0.8537)
    No Information Rate : 0.66            
    P-Value [Acc &gt; NIR] : 0.1475785       
                                          
                  Kappa : 0.5113          
                                          
 Mcnemar's Test P-Value : 0.0008741       
                                          
            Sensitivity : 1.0000          
            Specificity : 0.6061          
         Pos Pred Value : 0.5667          
         Neg Pred Value : 1.0000          
             Prevalence : 0.3400          
         Detection Rate : 0.3400          
   Detection Prevalence : 0.6000          
      Balanced Accuracy : 0.8030          
                                          
       'Positive' Class : FALSE           
                                          </code></pre>
</div>
</div>
<p>Note que nessa árvore, nosso modelo teve uma precisão de 80%. Bem menor do que o modelo de florestas.</p>
<p>Agora, observe que construimos uma floresta com 20 árvores. O que acontece com o erro do modelo conforme acrescentamos mais árvores?</p>
<p>Vamos avaliar o comportamento do erro conforme acrescentamos mais árvores à floresta. Para isso, utilizaremos a base de dados <strong>spam</strong> para melhor vizualização</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chamando a base</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"spam"</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo floresta com 20 arvores</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>spam, <span class="at">ntree=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observando o comportamento do erro em 20 árvores</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>erro_OOB <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Arvores =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate), <span class="at">times=</span><span class="dv">2</span>),</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"spam"</span>, <span class="st">"nonspam"</span>), <span class="at">each=</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate)),</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Erro =</span> <span class="fu">c</span>(modelo<span class="sc">$</span>err.rate[,<span class="st">"spam"</span>], modelo<span class="sc">$</span>err.rate[,<span class="st">"nonspam"</span>]))</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>erro_OOB, <span class="fu">aes</span>(<span class="at">x=</span>Arvores, <span class="at">y=</span>Erro)) <span class="sc">+</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span>Type),<span class="at">size=</span><span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_discrete</span>(<span class="at">name =</span> <span class="st">"Tipo"</span>,</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"nonspam"</span>, <span class="st">"spam"</span>),</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não Spam"</span>, <span class="st">"Spam"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo floresta com 50 arvores</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>spam, <span class="at">ntree=</span><span class="dv">50</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># observando o comportamento do erro em 50 árvores</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>erro_OOB <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Arvores=</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate), <span class="at">times=</span><span class="dv">2</span>),</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"spam"</span>, <span class="st">"nonspam"</span>), <span class="at">each=</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate)),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Erro=</span><span class="fu">c</span>(modelo<span class="sc">$</span>err.rate[,<span class="st">"spam"</span>],</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>          modelo<span class="sc">$</span>err.rate[,<span class="st">"nonspam"</span>]))</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>erro_OOB, <span class="fu">aes</span>(<span class="at">x=</span>Arvores, <span class="at">y=</span>Erro)) <span class="sc">+</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span>Type),<span class="at">size=</span><span class="fl">1.1</span>)<span class="sc">+</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_discrete</span>(<span class="at">name =</span> <span class="st">"Tipo"</span>,</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"nonspam"</span>, <span class="st">"spam"</span>),</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não Spam"</span>, <span class="st">"Spam"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo floresta com 100 arvores</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>spam, <span class="at">ntree=</span><span class="dv">100</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># observando o comportamento do erro em 100 árvores</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>erro_OOB <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Arvores=</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate), <span class="at">times=</span><span class="dv">2</span>),</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"spam"</span>, <span class="st">"nonspam"</span>), <span class="at">each=</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate)),</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Erro=</span><span class="fu">c</span>(modelo<span class="sc">$</span>err.rate[,<span class="st">"spam"</span>],</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>          modelo<span class="sc">$</span>err.rate[,<span class="st">"nonspam"</span>]))</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>erro_OOB, <span class="fu">aes</span>(<span class="at">x=</span>Arvores, <span class="at">y=</span>Erro)) <span class="sc">+</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span>Type),<span class="at">size=</span><span class="fl">1.1</span>)<span class="sc">+</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_discrete</span>(<span class="at">name =</span> <span class="st">"Tipo"</span>,</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"nonspam"</span>, <span class="st">"spam"</span>),</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não Spam"</span>, <span class="st">"Spam"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo floresta com 1000 arvores</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>spam, <span class="at">ntree=</span><span class="dv">1000</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># observando o comportamento do erro em 1000 árvores</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>erro_OOB <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Arvores=</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate), <span class="at">times=</span><span class="dv">2</span>),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"spam"</span>, <span class="st">"nonspam"</span>), <span class="at">each=</span><span class="fu">nrow</span>(modelo<span class="sc">$</span>err.rate)),</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Erro=</span><span class="fu">c</span>(modelo<span class="sc">$</span>err.rate[,<span class="st">"spam"</span>],</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>          modelo<span class="sc">$</span>err.rate[,<span class="st">"nonspam"</span>]))</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>erro_OOB, <span class="fu">aes</span>(<span class="at">x=</span>Arvores, <span class="at">y=</span>Erro)) <span class="sc">+</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span>Type),<span class="at">size=</span><span class="fl">1.1</span>)<span class="sc">+</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_discrete</span>(<span class="at">name =</span> <span class="st">"Tipo"</span>,</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"nonspam"</span>, <span class="st">"spam"</span>),</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não Spam"</span>, <span class="st">"Spam"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Repare que após uma certa quantidade de árvores, o erro se estabiliza. Sendo assim, não é necessário utilizar grandes quantidades de árvores em todos os casos. É preciso verificar até onde existe ganho.</p>
</section>
<section id="construindo-uma-floresta-com-o-train" class="level3" data-number="10.4.2">
<h3 data-number="10.4.2" class="anchored" data-anchor-id="construindo-uma-floresta-com-o-train"><span class="header-section-number">10.4.2</span> Construindo uma floresta com o <span class="red-text">train()</span></h3>
<p>Também é possivel fazer florestas aleatórias usando a função <span class="red-text">train</span> do pacote <span class="red-text">caret</span>. Para isso, é necessário alterar o método de reamostragem para <em>out of bag</em> e o método para “rf” (<em>random forest</em>). Vamos utilizar a base <span class="red-text">wine</span>, construiremos um regressor para predizer a variável <span class="red-text">alcohol</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alterando o metodo de reamostragem</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">trainControl</span>(<span class="at">method=</span><span class="st">"oob"</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># chamando a base</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"winequality-red.csv"</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># construindo o modelo com 50 arvores</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">534</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(alcohol <span class="sc">~</span> ., <span class="at">data=</span>wine, <span class="at">method=</span><span class="st">"rf"</span>, <span class="at">ntree=</span><span class="dv">50</span>, <span class="at">trControl=</span>controle)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest 

1599 samples
  11 predictor

No pre-processing
Resampling results across tuning parameters:

  mtry  RMSE       Rsquared 
   2    0.5507286  0.7327588
   6    0.5119701  0.7690503
  11    0.5025861  0.7774390

RMSE was used to select the optimal model using the smallest value.
The final value used for the model was mtry = 11.</code></pre>
</div>
</div>
<p>Note o valor “<span class="red-text">mtry</span>” no modelo. Ele indica a quantidade de váriaveis da base que foram utilizadas para treinar o modelo. Repare que ele calcula a RMSE e <span class="math inline">\(R^2\)</span> para diferentes quantidades de variáveis usadas e utiliza no final a quantidade que possuir menor RMSE, no caso mtry=11. Caso queira fixar o número de variáveis usadas, basta usar o seguinte comando.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>tng <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">.mtry=</span><span class="dv">7</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(alcohol<span class="sc">~</span>., <span class="at">data=</span>wine, <span class="at">method=</span><span class="st">"rf"</span>, <span class="at">ntree=</span><span class="dv">50</span>, <span class="at">trControl=</span>controle, <span class="at">tuneGrid=</span>tng)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest 

1599 samples
  11 predictor

No pre-processing
Resampling results:

  RMSE       Rsquared 
  0.5024407  0.7775677

Tuning parameter 'mtry' was held constant at a value of 7</code></pre>
</div>
</div>
</section>
<section id="adaboost" class="level3" data-number="10.4.3">
<h3 data-number="10.4.3" class="anchored" data-anchor-id="adaboost"><span class="header-section-number">10.4.3</span> <em>AdaBoost</em></h3>
<p>O método de treino AdaBoost se baseia na construção de uma floresta aleatória. Entretanto, na floresta construída por esse método as árvores possuem apenas um nó e duas folhas. Essas árvores são chamadas de tocos.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Floresta_AdaBoost-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Em geral, tocos não são muito bons em fazer classificações precisas, ou seja, eles são classificadores fracos. No entanto, o método AdaBoost os combina de forma a criar um bom aprendiz. Ele faz isso utilizando diferenciais na classificação e na construção das árvores que a floresta aleatória comum não utiliza:</p>
<ul>
<li><p>Floresta Aleatória: cada árvore de decisão tem um peso igual na classificação final das amostras. Além disso, cada árvore é construída independentemente das outras.</p></li>
<li><p>AdaBoost: alguns tocos têm mais peso na classificação final do que outros, e a ordem de construção dos tocos importam. Em outras palavras, os erros que o primeito toco comete influenciam em como o segundo toco é construído, os erros que o segundo toco comete influenciam em como o terceiro toco é construído, e assim sucessivamente.</p></li>
</ul>
<p>Vamos ver os detalhes práticos de como funciona o AdaBoost utilizando o banco de dados golf. Este banco possui informações sobre condições climáticas e se o indivíduo jogou golf no dia. A ideia é tentar prever se o indivíduo vai jogar golf baseado nas outras variáveis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>golf <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">"Golf.rds"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>golf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Outlook Humidity   Wind Play
1     Sunny     High   Weak   No
2     Sunny     High Strong   No
3  Overcast     High   Weak  Yes
4      Rain     High   Weak  Yes
5      Rain   Normal   Weak  Yes
6      Rain   Normal Strong   No
7  Overcast   Normal Strong  Yes
8     Sunny     High   Weak   No
9     Sunny   Normal   Weak  Yes
10     Rain   Normal   Weak  Yes
11    Sunny   Normal Strong  Yes
12 Overcast     High Strong  Yes
13 Overcast   Normal   Weak  Yes
14     Rain     High Strong   No</code></pre>
</div>
</div>
<p>Primeiramente construímos um toco para cada uma das variáveis e calculamos seus respectivos índices Gini. Vamos começar com a variável Outlook.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>golf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Outlook, Play) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   Outlook [3]
  Outlook  Play      N
  &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1 Overcast Yes       4
2 Rain     No        2
3 Rain     Yes       3
4 Sunny    No        3
5 Sunny    Yes       2</code></pre>
</div>
</div>
<p>Então temos que “Outlook = Overcast” separa os dados da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_Overcast.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Gini(Outlook = Overcast)</strong> <span class="math inline">\(= \frac{4}{14} \times \left[1 - (\frac{1}{14})^2 - (\frac{0}{14})^2 \right] + \frac{10}{14} \times \left[ 1 - (\frac{5}{10})^2 - (\frac{5}{10})^2 \right] = 0,357\)</span></p>
<p>Vamos agora olhar para “Outlook = Rain”:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_Rain.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Gini(Outlook = Rain)</strong> <span class="math inline">\(= \frac{5}{14} \times \left[1 - (\frac{3}{5})^2 - (\frac{2}{5})^2 \right] + \frac{9}{14} \times \left[ 1 - (\frac{6}{9})^2 - (\frac{3}{9})^2 \right] = 0,457\)</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_Sunny.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora vamos para a variável Humidity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>golf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Humidity, Play) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   Humidity [2]
  Humidity Play      N
  &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1 High     No        4
2 High     Yes       3
3 Normal   No        1
4 Normal   Yes       6</code></pre>
</div>
</div>
<p>Temos que “Humidity = High” separa os dados da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_High.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Gini(Humidity = High)</strong> <span class="math inline">\(= \frac{7}{14} \times \left[1 - (\frac{3}{7})^2 - (\frac{4}{7})^2 \right] + \frac{7}{14} \times \left[ 1 - (\frac{6}{7})^2 - (\frac{1}{7})^2 \right] = 0,367\)</span></p>
<p>Por último, a variável Wind:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>golf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Wind, Play) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   Wind [2]
  Wind   Play      N
  &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
1 Strong No        3
2 Strong Yes       3
3 Weak   No        2
4 Weak   Yes       6</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_Wind.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Gini(Wind = Strong)</strong> <span class="math inline">\(= \frac{6}{14} \times \left[1 - (\frac{3}{6})^2 - (\frac{3}{6})^2 \right] + \frac{8}{14} \times \left[ 1 - (\frac{6}{8})^2 - (\frac{2}{8})^2 \right] = 0,429\)</span></p>
<p>Logo, os índices Gini calculados foram:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variáveis</th>
<th>Índice Gini</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Outlook = Overcast</td>
<td>0,357</td>
</tr>
<tr class="even">
<td>Outlook = Rain</td>
<td>0,457</td>
</tr>
<tr class="odd">
<td>Outlook = Sunny</td>
<td>0,394</td>
</tr>
<tr class="even">
<td>Humidity = High</td>
<td>0,367</td>
</tr>
<tr class="odd">
<td>Wind = Strong</td>
<td>0,429</td>
</tr>
</tbody>
</table>
<p>Selecionamos a variável com o menor índice Gini para ser o primeiro toco da floresta. Nesse caso, o menor índice Gini é o da variável “Outlook = Overcast”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_toco.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora precisamos calcular o peso desse toco na classificação final. Para isso, vamos calcular seu erro total.</p>
<p>O erro total de um toco é calculado pelo número de amostras classificadas erradas dividido pelo total de amostras.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/AB_toco2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Para esse toco houve 5 amostras classificadas erradas em um total de 14. Logo,</p>
<div style="text-align: center;">
<p><strong>Erro Total</strong><span class="math inline">\(= \frac{5}{14}\)</span></p>
</div>
<p>Dessa forma podemos calcular o <em>Amount of Say</em> do toco, que será seu peso na classificação final.</p>
<p><strong>Amount of Say</strong> <span class="math inline">\(= \frac{1}{2} \times log \left( \frac{1-\frac{5}{14}}{\frac{5}{14}} \right) = 0,29\)</span></p>
<p>Então 0,29 é o seu peso na classificação final.</p>
<p>Agora vamos construir o próximo toco. Para isso damos um peso maior para as amostras que foram classificadas erroneamente no toco anterior. Essas amostras foram as seguintes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>golf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Outlook <span class="sc">!=</span> <span class="st">"Overcast"</span> <span class="sc">&amp;</span> Play <span class="sc">!=</span> <span class="st">"No"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Outlook Humidity   Wind Play
1    Rain     High   Weak  Yes
2    Rain   Normal   Weak  Yes
3   Sunny   Normal   Weak  Yes
4    Rain   Normal   Weak  Yes
5   Sunny   Normal Strong  Yes</code></pre>
</div>
</div>
<p>Então, para rebalancearmos os pesos das amostras classificadas de forma certa e errada, utilizamos as seguintes fórmulas:</p>
<p><strong>Peso Amostras Erradas</strong><span class="math inline">\(=\)</span> <strong>Erro Total</strong><span class="math inline">\(\times\)</span><span class="math inline">\(e^{Amount of Say}\)</span></p>
<p><strong>Peso Amostras Corretas</strong><span class="math inline">\(=\)</span> <strong>Erro Total</strong><span class="math inline">\(\times\)</span><span class="math inline">\(e^{-Amount of Say}\)</span></p>
<p>Assim, para o segundo toco, os pesos serão:</p>
<p><strong>Peso Amostras Erradas</strong><span class="math inline">\(= \frac{5}{14} \times e^{0,29} = 0,477\)</span></p>
<p><strong>Peso Amostras Erradas</strong><span class="math inline">\(= \frac{5}{14} \times e^{-0,29} = 0,267\)</span></p>
<p>Então temos os pesos para as amostras:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tabela_adaboost.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>A soma dos pesos das amostras deve ser 1, mas isso não ocorre: note que a soma resulta em 4,788. Dessa forma, precisamos reescalar os pesos. Faremos isso dividindo cada um deles por 4,788.</p>
<p>Feito isso, temos uma nova tabela de pesos:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tabela_adaboost2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Definidos os pesos, em seguida realizamos uma reamostragem via bootstrap (uma amostragem da própria amostra, com reposição) do mesmo tamanho da base de dados original. A probabilidade de um elemento da amostra ser sorteado é o peso dele.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Numerando os elementos da amostra:</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>amostra <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Definindo as probabilidades dos elementos serem sorteados:</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>pesos <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="fl">0.056</span>, <span class="fl">0.099</span>, <span class="fl">0.056</span>, <span class="fl">0.099</span>, <span class="fl">0.056</span>), <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizando o bootstrap:</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">271</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(amostra, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">replace =</span> T, <span class="at">prob =</span> pesos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 11  7  5  5  9 10  9 11  1 11 13 12  6  3</code></pre>
</div>
</div>
<p>Então temos uma nova amostra formada pelos elementos sorteados na reamostragem:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tabela_bootstrap.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora, com essa nova amostra, fixamos pesos uniformes para os elementos e repetimos o processo de criação para o próximo toco. Em seguida verificamos os elementos que foram classificados de forma errada, aumentamos seus pesos no banco de dados e repetimos o processo de bootstrap, construindo, assim, o próximo toco. O processo se repete até que a floresta de tocos esteja concluída.</p>
<p>Finalizada a floresta, realizamos a classificação final dos elementos somando os pesos dos tocos para cada classificação e selecionando o maior deles. Por exemplo, em uma floresta com 10 árvores onde 5 delas classificam a amostra na categoria de interesse como “positivo” e 5 delas classificam essa mesma amostra como “negativo”, se a soma dos pesos das que classificaram a amostra como “positivo” for 2,7 e a das que classificaram a amostra como “negativo” for 0,84, a amostra será classificada como “positivo”.</p>
</section>
<section id="adaboost-com-o-pacote-adabag" class="level3" data-number="10.4.4">
<h3 data-number="10.4.4" class="anchored" data-anchor-id="adaboost-com-o-pacote-adabag"><span class="header-section-number">10.4.4</span> Adaboost com o pacote <span class="red-text">adabag</span></h3>
<p>Agora que já sabemos como funciona o <em>adaboost</em>, vamos botá-lo em prática através do pacote adabag. Vamos utilizar a base de dados spam.</p>
<p>Inicialmente vamos separar a amostra em treino e teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(spam)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">16</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(<span class="at">y =</span> spam<span class="sc">$</span>type, <span class="at">p =</span> <span class="fl">0.7</span>, <span class="at">list =</span> F)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> spam[noTreino,]</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> spam[<span class="sc">-</span>noTreino,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Antes de realizarmos o adaboost precisamos definir a profundidade máxima que as árvores da floresta terão. Faremos isso através do comando rpart.control(). Como o objetivo é construir uma floresta de tocos, as árvores terão todas profundidade 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">rpart.control</span>(<span class="at">maxdepth =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora vamos aplicar o método adaboost no conjunto treino utilizando o comando boosting().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(adabag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Carregando pacotes exigidos: foreach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Carregando pacotes exigidos: doParallel</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Carregando pacotes exigidos: iterators</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Carregando pacotes exigidos: parallel</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">16</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">boosting</span>(<span class="at">formula =</span> type<span class="sc">~</span>., <span class="at">data =</span> treino, <span class="at">boos =</span> T, <span class="at">mfinal =</span> <span class="dv">100</span>,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">coeflearn =</span> <span class="st">"Breiman"</span>, <span class="at">control =</span> controle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os principais argumentos dessa função são:</p>
<ul>
<li>formula = uma fórmula especificando qual variável queremos prever em função de qual(is);</li>
<li>data = base de dados onde se encontram as variáveis;</li>
<li>boos = argumento do tipo logical onde, se TRUE (default), utiliza bootstrap para criar uma nova amostra treino para a próxima árvore baseado nos erros da árvore anterior;</li>
<li>mfinal = número de árvores da floresta;</li>
<li>coeflearn = define qual fórmula será utilizada para o Amount of Say de cada árvore. A que vimos é a fórmula de Breiman (default);</li>
<li>control = opções que controlam detalhes do algoritmo rpart.</li>
</ul>
<p>Para visualizarmos qualquer árvore da floresta utilizamos o comando rpart.plot().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizando a primeira árvore construída:</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(modelo<span class="sc">$</span>trees[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot retrieve the data used to build the model (so cannot determine roundint and is.binary for the variables).
To silence this warning:
    Call rpart.plot with roundint=FALSE,
    or rebuild the rpart model with model=TRUE.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Por último, vamos aplicar o modelo na amostra teste e em seguida avaliar o modelo através da matriz de confusão.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Podemos obter a matriz de confusão com o seguinte comando:</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>predicao<span class="sc">$</span>confusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Observed Class
Predicted Class nonspam spam
        nonspam     807   61
        spam         29  482</code></pre>
</div>
</div>
<p>Ou utilizamos a função confusionMatrix() para, além da matriz de confusão, obtermos demais medidas avaliativas do modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformando em fator para utilizar a função confusionMatrix():</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>predicao<span class="sc">$</span>class <span class="ot">=</span> <span class="fu">as.factor</span>(predicao<span class="sc">$</span>class)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>teste<span class="sc">$</span>type <span class="ot">=</span> <span class="fu">as.factor</span>(teste<span class="sc">$</span>type)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Matriz de confusão e demais medidas avaliativas:</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(predicao<span class="sc">$</span>class, teste<span class="sc">$</span>type, <span class="at">positive =</span> <span class="st">"spam"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction nonspam spam
   nonspam     807   61
   spam         29  482
                                          
               Accuracy : 0.9347          
                 95% CI : (0.9204, 0.9472)
    No Information Rate : 0.6062          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.8619          
                                          
 Mcnemar's Test P-Value : 0.001084        
                                          
            Sensitivity : 0.8877          
            Specificity : 0.9653          
         Pos Pred Value : 0.9432          
         Neg Pred Value : 0.9297          
             Prevalence : 0.3938          
         Detection Rate : 0.3495          
   Detection Prevalence : 0.3706          
      Balanced Accuracy : 0.9265          
                                          
       'Positive' Class : spam            
                                          </code></pre>
</div>
</div>
<p>Repare que obtivemos uma ótima precisão e especificidade. A sensibilidade não foi tão boa quanto elas, mas talvez deva melhorar se aumentarmos o número de árvores da floresta.</p>
</section>
<section id="adaboost-com-o-train" class="level3" data-number="10.4.5">
<h3 data-number="10.4.5" class="anchored" data-anchor-id="adaboost-com-o-train"><span class="header-section-number">10.4.5</span> Adaboost com o <span class="red-text">train</span></h3>
<p>Também podemos utilizar o adaboost através da função train(). Para isso basta escolhermos a opção “AdaBoost.M1” no argumento referente ao método de treino que será utilizado. Vamos fazer isso utilizando a base de dados College.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>college <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"College.csv"</span>)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>college <span class="ot">=</span> college[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Separando a amostra em treino e teste:</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">createDataPartition</span>(<span class="at">y =</span> college<span class="sc">$</span>Private, <span class="at">p =</span> <span class="fl">0.7</span>, <span class="at">list =</span> F)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> college[noTreino,]</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> college[<span class="sc">-</span>noTreino,]</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Para utilizar o adaboost no train primeiramente precisamos fixar os parâmetros maxdepth,</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="co"># coeflearn e mfinal:N</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>controle <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">maxdepth =</span> <span class="dv">1</span>, <span class="at">coeflearn =</span> <span class="st">"Breiman"</span>, <span class="at">mfinal =</span> <span class="dv">10</span>)</span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Treinando o modelo com o adaboost:</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(Private<span class="sc">~</span>., <span class="at">method =</span> <span class="st">"AdaBoost.M1"</span>, <span class="at">data =</span> treino, <span class="at">tuneGrid =</span> controle)</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AdaBoost.M1 

545 samples
 17 predictor
  2 classes: 'No', 'Yes' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 545, 545, 545, 545, 545, 545, ... 
Resampling results:

  Accuracy   Kappa    
  0.9216357  0.7980984

Tuning parameter 'mfinal' was held constant at a value of 10
Tuning
 parameter 'maxdepth' was held constant at a value of 1
Tuning
 parameter 'coeflearn' was held constant at a value of Breiman</code></pre>
</div>
</div>
<p>Vamos aplicar o modelo no conjunto teste e avaliá-lo através da matriz de confusão.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformando em fator para depois construirmos a matriz de confusão:</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>teste<span class="sc">$</span>Private <span class="ot">=</span> <span class="fu">as.factor</span>(teste<span class="sc">$</span>Private)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Construindo a matriz de confusão:</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(predicao, teste<span class="sc">$</span>Private)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  No Yes
       No   53   9
       Yes  10 160
                                        
               Accuracy : 0.9181        
                 95% CI : (0.8751, 0.95)
    No Information Rate : 0.7284        
    P-Value [Acc &gt; NIR] : 3.803e-13     
                                        
                  Kappa : 0.792         
                                        
 Mcnemar's Test P-Value : 1             
                                        
            Sensitivity : 0.8413        
            Specificity : 0.9467        
         Pos Pred Value : 0.8548        
         Neg Pred Value : 0.9412        
             Prevalence : 0.2716        
         Detection Rate : 0.2284        
   Detection Prevalence : 0.2672        
      Balanced Accuracy : 0.8940        
                                        
       'Positive' Class : No            
                                        </code></pre>
</div>
</div>
<p>Note que obtivemos bons resultados mesmo utilizando apenas 10 árvores. A acurácia, em particular, foi maior que 0,9, o que já é um bom indicativo de que o modelo se adequou bem aos dados.</p>
</section>
</section>
<section id="gradiente-boosting" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="gradiente-boosting"><span class="header-section-number">10.5</span> Gradiente Boosting</h2>
<section id="em-regressão-1" class="level3" data-number="10.5.1">
<h3 data-number="10.5.1" class="anchored" data-anchor-id="em-regressão-1"><span class="header-section-number">10.5.1</span> em Regressão</h3>
<p>De acordo com Jerome Friedman, o criador do Gradiente Boosting, evidências empíricas mostram que dar pequenos passos ou ir gradativamente na direção correta resulta em melhores predições na amostra teste, ou seja, menor variância.</p>
<p>Para entendermos como funciona o Gradiente Boosting, considere a seguinte base de dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="do">##   Altura      Cor Sexo Peso</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1    1.6     Azul    M   88</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 2    1.6    Verde    F   76</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 3    1.5     Azul    F   56</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 4    1.8 Vermelho    M   75</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 5    1.5    Verde    M   77</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 6    1.4     Azul    F   57</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A primeira coisa a fazer é definir um número máximo de folhas de cada árvore. Para nosso exemplo, vamos definir 4 folhas, mas em geral, é definido uma quantidade de 8 a 32 folhas. Feito isso, tiramos uma média dos pesos dos indivíduos e essa será nossa primeira árvore, uma árvore só com a raiz.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGB.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora, calculamos o <strong>Pseudo-Resíduo</strong>, o erro de previsão de cada indivíduo, da forma <strong>Pseudo-Resíduo</strong> <span class="math inline">\(=\)</span> <strong>Valor Real</strong> <span class="math inline">\(-\)</span> <strong>Valor Predito</strong> para cada observação. Então, por exemplo, o pseudo-resíduo da primeira observação vai ficar <span class="math inline">\(88 - 71.5 = 16,5\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="do">##   Altura      Cor Sexo Peso Ps..Res..1</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1    1.6     Azul    M   88       16.5</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 2    1.6    Verde    F   76        4.5</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 3    1.5     Azul    F   56      -15.5</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 4    1.8 Vermelho    M   75        3.5</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 5    1.5    Verde    M   77        5.5</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 6    1.4     Azul    F   57      -14.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O termo <strong>pseudo-resíduo</strong> é baseado em Regressão Linear, onde o resíduo é a diferença entre os valores observados e estimados. O termo “pseudo” serve para lembrar que estamos fazendo <strong>Gradiente Boosting</strong> e não Regressão Linear.</p>
<p>O próximo passo é, utilizando as variáveis explicativas (Altura, Cor e Sexo), construir uma árvore de decisão respeitando o máximo de folhas definido anteriormente. Mas ela deve <strong>predizer o pseudo-resíduo</strong> e não o Peso.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/GB1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que temos mais observações do que folhas, sendo assim, podemos ter mais que um resultado em cada uma. Nesse caso, substituímos os valores pela média das folhas.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/GB2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora somamos o resultado das duas árvores para classificar na primeira observação, por exemplo, a predição seria <span class="math inline">\(71,5 + 16,5 = 88\)</span>. Acertamos exatamente o valor real. Isso é bom? Não. Já vimos como não é bom ter um modelo muito ajustado. Temos pouco viés, mas provavelmente alta variância.</p>
<p>O Gradiente Boosting lida com esse problema usando uma taxa de aprendizado para reescalar a contribuição da nova árvore. A taxa de aprendizado é um número entre 0 e 1 e deve ser multiplicado ao valor da segunda árvore em diante. Para esse exemplo, vamos adotar uma taxa de 0.1, assim a predição da primeira observação seria <span class="math inline">\(71,5 + (0,1 \times 16,5) = 73,15\)</span>. A predição não ficou tão boa, mas é um pouco melhor do que o resultado de apenas uma árvore.</p>
<p>Feito isso, recalculamos os valores do pseudo-resíduo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="do">##   Altura      Cor Sexo Peso Ps..Res..1 Ps..Res..2</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1    1.6     Azul    M   88       16.5      14.85</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 2    1.6    Verde    F   76        4.5       4.05</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 3    1.5     Azul    F   56      -15.5     -14.00</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 4    1.8 Vermelho    M   75        3.5       3.05</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 5    1.5    Verde    M   77        5.5       5.05</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 6    1.4     Azul    F   57      -14.5     -13.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Repare que o valor do segundo pseudo-resíduo diminuiu em módulo em relação ao primeiro, ou seja, nos aproximamos mais do valor correto do que da primeira vez.</p>
<p>Agora, utilizando novamente as variáveis explicativas, construímos outra árvore agora para predizer o segundo pseudo-resíduo.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/GB3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que a estrutura da segunda árvore construída ficou semelhante a primeira. Isso não acontece sempre, mas pode acontecer.</p>
<p>Agora, a classificação da primeira observação ficaria <span class="math inline">\(71.5+(0.116.5)+(0.114.85)=74.635\)</span> um pouco mais perto do verdadeiro valor. Repetimos esse procedimento quantas vezes se queira ou até não ter redução significante dos valores do pseudo-resíduo. Dessa forma temos uma sequência de árvores que caminham em direção ao valor correto em passos pequenos.</p>
<p>É importante notar que todas as árvores devem possuir a mesma taxa de aprendizado.</p>
</section>
<section id="construindo-um-regressor-com-o-pacote-gbm" class="level3" data-number="10.5.2">
<h3 data-number="10.5.2" class="anchored" data-anchor-id="construindo-um-regressor-com-o-pacote-gbm"><span class="header-section-number">10.5.2</span> Construindo um regressor com o pacote <strong>gbm</strong></h3>
<p>Para nosso exemplo, vamos utilizar a base de dados <strong>Wage</strong> do pacote ISLR. Para isso, vamos precisar limpar os dados removendo variáveis de variância zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lendo a base de dados</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ISLR)</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Wage"</span>)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co"># removendo variaveis de variancia zero</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>vvz <span class="ot">=</span> <span class="fu">nearZeroVar</span>(Wage,<span class="at">saveMetrics =</span> F)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>vvz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>Wage <span class="ot">=</span> Wage[,<span class="sc">-</span>vvz]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Dividimos a base nos conjuntos de treino e teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(Wage<span class="sc">$</span>wage,<span class="at">p=</span><span class="fl">0.7</span>,<span class="at">list=</span>F)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> Wage[noTreino,]</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> Wage[<span class="sc">-</span>noTreino,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora vamos aplicar o gradiente boosting com a função <strong>gbm()</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">gbm</span>(wage<span class="sc">~</span>.,<span class="at">data=</span>treino, <span class="at">distribution=</span><span class="st">"gaussian"</span>,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.trees =</span><span class="dv">300</span>,<span class="at">interaction.depth =</span> <span class="dv">20</span>)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>modelo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gbm(formula = wage ~ ., distribution = "gaussian", data = treino, 
    n.trees = 300, interaction.depth = 20)
A gradient boosted model with gaussian loss function.
300 iterations were performed.
There were 9 predictors of which 9 had non-zero influence.</code></pre>
</div>
</div>
<p>Os principais argumentos da função gbm() são:</p>
<ul>
<li><strong>distribution:</strong> gaussian se for regressão, multinomial se for um classificação, bernoulli se for classificação 0-1.</li>
<li><strong>n.trees:</strong> número de árvores da floresta.</li>
<li><strong>interaction.depth:</strong> profundidade máxima das árvores.</li>
</ul>
<p>Vamos aplicar o modelo na amostra teste, e avaliar o resultado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste, <span class="at">n.trees=</span><span class="dv">300</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="co"># avaliando</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="fu">postResample</span>(predicao,teste<span class="sc">$</span>wage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     RMSE  Rsquared       MAE 
0.7297289 0.9996961 0.1742759 </code></pre>
</div>
</div>
<p>Note que utilizamos 300 árvores. Mas pode ser que não seja necessário essa quantidade de árvores pra alcançar esses valores de<span class="math inline">\(R^2\)</span>, RMSE e MAE. Para saber a quantidade ideal de árvores, isto é, quando erro se estabiliza, podemos utilizar a função <span class="red-text">gbm.perf()</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(modelo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>OOB generally underestimates the optimal number of iterations although predictive performance is reasonably competitive. Using cv_folds&gt;1 when calling gbm usually results in improved predictive performance.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 48
attr(,"smoother")
Call:
loess(formula = object$oobag.improve ~ x, enp.target = min(max(4, 
    length(x)/10), 50))

Number of Observations: 300 
Equivalent Number of Parameters: 24.11 
Residual Standard Error: 5.161 </code></pre>
</div>
</div>
<p>Sendo assim, com apenas 50 árvores teríamos chegado a um resultado razoável.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>predicao2 <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste, <span class="at">n.trees=</span><span class="dv">50</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">postResample</span>(predicao2,teste<span class="sc">$</span>wage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     RMSE  Rsquared       MAE 
1.0759904 0.9993670 0.2823224 </code></pre>
</div>
</div>
<p>Podemos ver que o RMSE e o MAE aumentaram um pouco, porém o<span class="math inline">\(R^2\)</span> foi praticamente o mesmo. E como tivemos um custo computacional muito menor, podemos concluir que esse modelo com 50 árvores acaba sendo melhor do que o com 300.</p>
</section>
<section id="em-classificação-1" class="level3" data-number="10.5.3">
<h3 data-number="10.5.3" class="anchored" data-anchor-id="em-classificação-1"><span class="header-section-number">10.5.3</span> em Classificação</h3>
<p>Considere a seguinte base de dados</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 4</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   `Gosta de Pipoca` Idade `Cor Favorita` `Troll 2`</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;    </span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Sim                  12 Azul           Ama      </span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Sim                  87 Verde          Ama      </span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Nao                  44 Azul           Odeia    </span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 Sim                  19 Vermelho       Odeia    </span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 Nao                  32 Verde          Ama      </span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 Nao                  14 Azul           Ama</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Queremos predizer se uma pessoa ama o filme Troll 2 baseado em seu gosto por pipoca, idade e cor favorita. Assim como em regressão, começamos o método de Gradiente Boosting usando uma árvore raiz que represente nossa predição inicial para cada observação. Em regressão usamos a média das observações, em classificação vamos usar o log(chances). Olhando na base de dados, podemos dizer que as chances de alguém amar Troll 2 é <strong>chances</strong> <span class="math inline">\(= \frac{\text{quantidade de indivíduos que amaram}}{\text{quantidade de indivíduos que odiaram}} = \frac{4}{2}\)</span>, e portanto, o<span class="math inline">\(log(chances) = log(\frac{4}{2}) = 0,6932\)</span> e é isso que colocaremos na folha inicial.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGBC.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>O jeito mais fácil de usar o log(chances) para classificar é convertendo em probabilidade, e fazemos isso usando a seguinte função:</p>
<div style="text-align: center;">
<p><strong>Probabilidade</strong> <span class="math inline">\(= \frac{e^{log(chances)}}{1 + e^{log(chances)}}\)</span></p>
</div>
<p>Sendo assim, a <strong>Probabilidade de alguém amar Troll 2</strong> <span class="math inline">\(= \frac{e^{log(\frac{4}{2})}}{1 + e^{log(\frac{4}{2})}} = \frac{2}{3} = 0,6667\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGBC2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>É importante notar que o log(chances) e a probabilidade só ficaram iguais por causa da aproximação.</p>
<p>Vamos criar o seguinte classificador:</p>
<ul>
<li>Probabilidade acima de 0,5: classificamos que ama Troll 2;</li>
<li>Probabilidade menor ou igual a 0,5: classificamos que odeia Troll 2.</li>
</ul>
<p>Como a probabilidade ficou maior que 0,5 classificamos todos no treino como indivíduos que amam Troll 2.</p>
<p>Embora 0,5 seja um limite usual para tomada de decisão baseada em probabilidade, poderiamos tranquilamente usar um valor diferente.</p>
<p>Mas a classificação não ficou muito boa já que 2 indivíduos foram classificados erroneamente. Podemos mensurar quão ruim foi a predição calculando o <strong>pseudo-resíduo = observado - predito</strong>. Para essa conta, perceba que se um indivíduo ama Troll 2, então a probabilidade dele amar Troll 2 é 1. Semelhantemente, se ele odeia, a probabilidade dele amar é 0. Assim, calculamos os pseudo-resíduos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 5</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   `Gosta de Pipoca` Idade `Cor Favorita` `Troll 2` `Ps. Res. 1`</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;            &lt;dbl&gt;</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Sim                  12 Azul           Ama                0.3</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Sim                  87 Verde          Ama                0.3</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Nao                  44 Azul           Odeia             -0.7</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 Sim                  19 Vermelho       Odeia             -0.7</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 Nao                  32 Verde          Ama                0.3</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 Nao                  14 Azul           Ama                0.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora construímos uma árvore utilizando as variáveis explicativas para predizer o pseudo-resíduo. Assim como o Gradiente Boosting para regressão, temos que definir um número máximo de folhas em cada árvore. Aqui vamos limitar a 3 folhas, mas na prática geralmente é um número entre 8 e 32.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGBC3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Em regressão, os valores das folhas representavam os resíduos. Mas em classificação isso é mais complexo. Isso porque a predição está em log(chances) e as folhas são provenientes de probabilidade. Portanto não podemos apenas somá-las para uma nova predição sem alguma transformação. A transformação mais comum por folha é:</p>
<div style="text-align: center;">
<p><span class="math inline">\(\frac{\sum \text{residuos}}{\sum{[probabilidade \space anterior \space \times \space (1 - probabilidade \space anterior)]}}\)</span></p>
</div>
<p>Assim, da esquerda pra direita, para primeira folha temos:</p>
<p><span class="math inline">\(\frac{\sum \text{residuos}}{\sum{[probabilidade \space anterior \space \times \space (1 - probabilidade \space anterior)]}} = \frac{-0.7}{0.7 \times (0.3)} = -0.3333\)</span>, para a segunda</p>
<p><span class="math inline">\(\frac{\sum \text{residuos}}{\sum{[probabilidade \space anterior \space \times \space (1 - probabilidade \space anterior)]}} = \frac{0.3 - 0.7}{0.7 \times (1 - 0.7) + 0.7 \times (1-0.7)} = -0.9524\)</span>, e para a última</p>
<p><span class="math inline">\(\frac{\sum \text{residuos}}{\sum{[probabilidade \space anterior \space \times \space (1 - probabilidade \space anterior)]}} = \frac{0.3 + 0.3 + 0.3}{0.7 \times (1 - 0.7) + 0.7 \times (1-0.7) + 0.7 \times (1-0.7)} = 1.4286\)</span></p>
<p>Por enquanto, a probabilidade anterior é a mesma para todos, mas a partir da próxima árvore isso muda.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGBC4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora que todas as folhas foram alteradas, podemos somar os resultados escalados pela taxa de aprendizado. Nesse exemplo, vamos usar uma taxa alta, 0.8. Mas geralmente se usa 0.1. E então calculamos o novo</p>
<p><span class="math inline">\(log(chances) = log(chances) \space anterior + taxa \space de \space aprendizado \space \times \space log(chances)\)</span> obtido na árvore.</p>
<p>Para primeira observação, por exemplo, fica <span class="math inline">\(log(chances) = 0.7 = (0.8 \times 1.4) = 1.82\)</span> e então convertemos em probabilidade <span class="math inline">\(\frac{e^{1.82}}{1 + e^{1.82}} = 0.8606\)</span>. Então, note que fizemos progresso, já que o indivíduo em questão ama Troll 2. Antes ele foi classificado corretamente mas com probabilidade 0.7, agora ele foi classificado corretamente mas com probabilidade 0.9.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 5</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   `Gosta de Pipoca` Idade `Cor Favorita` `Troll 2` `Prob. Predita`</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;               &lt;dbl&gt;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Sim                  12 Azul           Ama                   0.9</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Sim                  87 Verde          Ama                   0.5</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Nao                  44 Azul           Odeia                 0.5</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 Sim                  19 Vermelho       Odeia                 0.1</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 Nao                  32 Verde          Ama                   0.9</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 Nao                  14 Azul           Ama                   0.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pode ser que a previsão fique pior, como no caso do segundo indivíduo. E essa é a razão de construírmos várias árvores e não só uma.</p>
<p>Calculamos os novos pseudo-resíduos que agora serão diferentes para cada observação.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 5</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   `Gosta de Pipoca` Idade `Cor Favorita` `Troll 2` `Ps. Res. 2`</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;            &lt;dbl&gt;</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Sim                  12 Azul           Ama                0.1</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Sim                  87 Verde          Ama                0.5</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Nao                  44 Azul           Odeia             -0.5</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 Sim                  19 Vermelho       Odeia             -0.1</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 Nao                  32 Verde          Ama                0.1</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 Nao                  14 Azul           Ama                0.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Construímos uma segunda árvore agora para prever os novos pseudo-resíduos e fazemos a transformação para log(chances) para cada folha.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tocoGBC5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Combinamos com as árvores anteriores para obter um valor de saída e transformamos em Probabilidade para classificar. Por exemplo, a primeira observação ficaria:</p>
<p><span class="math inline">\(log(chances)=0.7+(0.81.4)+(0.80.6)=2.3\)</span></p>
<p>e então, convertendo em probabilidade:</p>
<p><span class="math inline">\(\frac{e^{1.82}}{1+e^{1.82}} = 0.9089\)</span></p>
<p>Dessa forma, continuamos construíndo quantas árvores forem necessárias.</p>
</section>
<section id="construindo-um-classificador-com-o-pacote-gbm" class="level3" data-number="10.5.4">
<h3 data-number="10.5.4" class="anchored" data-anchor-id="construindo-um-classificador-com-o-pacote-gbm"><span class="header-section-number">10.5.4</span> Construindo um classificador com o pacote <span class="red-text">gbm</span></h3>
<p>O gradiente boosting para classificação no R é semelhante ao para regressão, atentando para o argumento distribution, que deve ser igual a “bernoulli” se a variável de interesse tiver apenas duas respostas possíveis (como no caso da bse Troll 2) ou “multinomial” se a variável tiver mais de duas respostas possíveis. Por exemplo, considere a base Vehicle do pacote mlbench. Nela, estamos interessados em classificar a variável Class, que pode ser bus, opel, saab ou van.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lendo a base</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlbench)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Vehicle)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># dividindo em treino e teste</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(Vehicle<span class="sc">$</span>Class,<span class="at">p=</span><span class="fl">0.7</span>,<span class="at">list=</span>F)</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> Vehicle[noTreino,]</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> Vehicle[<span class="sc">-</span>noTreino,]</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="co"># treinando o modelo</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">gbm</span>(Class<span class="sc">~</span>.,<span class="at">data=</span>treino,<span class="at">distribution=</span><span class="st">"multinomial"</span>,</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.trees =</span> <span class="dv">100</span>,<span class="at">interaction.depth =</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Setting `distribution = "multinomial"` is ill-advised as it is
currently broken. It exists only for backwards compatibility. Use at your own
risk.</code></pre>
</div>
</div>
<p>Quando aplicamos o predict(), o que recebemos de retorno são um conjunto de probabilidades (ou o log(chances)), e não a classificação final. Cabe ao pesquisador definir a regra de classificação final.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste, <span class="at">n.trees =</span> <span class="dv">100</span>, <span class="at">type =</span> <span class="st">'response'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Criando a regra de classificacao</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="fu">dim</span>(teste)[<span class="dv">1</span>]</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>classe <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  classe[i] <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">which.max</span>(predicao[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">1</span>])) </span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(classe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "van"  "van"  "opel" "van"  "bus"  "saab"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># verificando quantidade de arvores necessarias</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(modelo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>OOB generally underestimates the optimal number of iterations although predictive performance is reasonably competitive. Using cv_folds&gt;1 when calling gbm usually results in improved predictive performance.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 16
attr(,"smoother")
Call:
loess(formula = object$oobag.improve ~ x, enp.target = min(max(4, 
    length(x)/10), 50))

Number of Observations: 100 
Equivalent Number of Parameters: 8.32 
Residual Standard Error: 0.0121 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># avaliando o modelo </span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(<span class="at">data=</span><span class="fu">as.factor</span>(classe), <span class="at">reference=</span><span class="fu">as.factor</span>(teste<span class="sc">$</span>Class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction bus opel saab van
      bus   62    2    0   1
      opel   0   39   23   1
      saab   3   20   39   0
      van    0    2    3  57

Overall Statistics
                                          
               Accuracy : 0.7817          
                 95% CI : (0.7256, 0.8311)
    No Information Rate : 0.2579          
    P-Value [Acc &gt; NIR] : &lt;2e-16          
                                          
                  Kappa : 0.709           
                                          
 Mcnemar's Test P-Value : 0.1453          

Statistics by Class:

                     Class: bus Class: opel Class: saab Class: van
Sensitivity              0.9538      0.6190      0.6000     0.9661
Specificity              0.9840      0.8730      0.8770     0.9741
Pos Pred Value           0.9538      0.6190      0.6290     0.9194
Neg Pred Value           0.9840      0.8730      0.8632     0.9895
Prevalence               0.2579      0.2500      0.2579     0.2341
Detection Rate           0.2460      0.1548      0.1548     0.2262
Detection Prevalence     0.2579      0.2500      0.2460     0.2460
Balanced Accuracy        0.9689      0.7460      0.7385     0.9701</code></pre>
</div>
</div>
<p>Note que o modelo obteve uma precisão razoável de 75,79%.</p>
</section>
</section>
<section id="xgboost" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">10.6</span> XGBoost</h2>
<p>O XGBoost é a abreviação de <strong>Extreme Gradient Boost</strong>. Ele foi desenvolvido para suportar um grande volume de dados de forma eficiente. Geralmente é 10 vezes mais rápido que o Gradiente Boosting.</p>
<section id="em-regressão-2" class="level3" data-number="10.6.1">
<h3 data-number="10.6.1" class="anchored" data-anchor-id="em-regressão-2"><span class="header-section-number">10.6.1</span> Em Regressão</h3>
<p>Apesar do XGBoost ser usado para lidar com bases grandes, vamos usar uma base de dados bem pequena só para entendermos melhor como ele funciona. Para isso considere a seguinte situação: queremos predizer o peso de um indivíduo em função de sua altura.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lendo e vizualizando a base</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>peso <span class="ot">=</span> <span class="fu">read_csv2</span>(<span class="st">"peso-altura.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Using "','" as decimal and "'.'" as grouping mark. Use `read_delim()` for more control.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 5 Columns: 2
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
dbl (1): Peso
num (1): Altura

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(peso, <span class="fu">aes</span>(<span class="at">x=</span>Altura, <span class="at">y=</span>Peso)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">lwd=</span><span class="dv">5</span>, <span class="at">colour =</span> <span class="st">"deeppink3"</span>) <span class="sc">+</span> </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">90</span>)) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="fl">1.3</span>,<span class="fl">1.9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_point(lwd = 5, colour = "deeppink3"): Ignoring unknown
parameters: `linewidth`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 5 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>O primeiro passo é fazer uma predição inicial, que pode ser qualquer uma. O default é usar 0,5, mas como estamos falando de peso, vamos utilizar a predição inicial “Peso = 70”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora precisamos calcular os resíduos (diferença entre o valor real e o valor predito) que vão nos mostrar quão boa é essa predição.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>(<span class="at">peso =</span> peso <span class="sc">%&gt;%</span> <span class="fu">mutate</span>( <span class="at">residuos =</span> Peso<span class="dv">-70</span> ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  Altura  Peso residuos
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1     17    88       18
2     16    76        6
3     15    56      -14
4     18    75        5
5     14    60      -10</code></pre>
</div>
</div>
<p>Assim como no Gradiente Boosting, o próximo passo é construir uma árvore para predizer os resíduos. Mas o XGBoost utiliza uma árvore de regressão diferente que vamos chamar de árvore XGB. Existem muitas formas de construir uma árvore XGB. Vamos aprender a mais comum. A árvore XGB inicia com uma folha que leva todos os resíduos.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Em seguida, calculamos um índice de qualidade ou <strong>Índice de Similaridade</strong>.</p>
<p><span class="math inline">\(\text{Índice de Similaridade} = \frac{(\sum \text{resíduos})^2}{\text{número de resíduos} + \lambda}\)</span></p>
<p>Onde <span class="math inline">\(\lambda\)</span> (Lambda) é um parâmetro de regularização, o que significa que tem o objetivo de reduzir a sensibilidade das observações individuais, ou seja, reduzir o sobreajuste. Por enquanto, vamos considerar <span class="math inline">\(\lambda = 0\)</span> porque esse é o valor default. Sendo assim, o Índice de similaridade da raiz é <span class="math inline">\(\frac{(18 + 6 - 14 + 5 - 10)^2}{5 + 0} = \frac{5^2}{5} = 5\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora vamos ver se conseguimos melhorar esse índice dividindo os resíduos, ou seja, criando uma ramificação. Vamos começar dividindo a variável <strong>Altura</strong> na média entre os dois menores valores, que são 1.4 e 1.5, e calculando o Indice para as novas folhas.</p>
<p>Observe que nas folhas não estarão as alturas e sim os resíduos correspondentes a altura especificada.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora, precisamos calcular o ganho dessa ramificação para ver o quanto ela foi efetiva. O ganho é calculado da seguinte forma:</p>
<p>Agora, precisamos calcular o ganho dessa ramificação para ver o quanto ela foi efetiva. O ganho é calculado da seguinte forma:</p>
<p><span class="math inline">\(ganho = IS\_{folha \space da \space esquerda} + IS\_{folha \space da \space direita - IS\_{raiz}}\)</span>.</p>
<p>Assim, o ganho da ramificação <span class="math inline">\(Altura &lt; 1.45\)</span> é <span class="math inline">\(100 + 56.25 - 5 =151.25\)</span>. Vamos fazer esse calculo em todas as ramificações possiveis, Isto é, se temos 5 observações com diferentes alturas, vamos ter 4 ramificações possiveis: <strong>Altura&lt;1.45</strong>, <strong>Altura&lt;1.55</strong>, <strong>Altura&lt;1.65</strong> e <strong>Altura&lt;1.75</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Podemos ver que o ganho de usar a ramificação ‘Altura&lt;1.55’ é maior, portanto é essa que vamos usar. Agora vamos ramificar as folhas da mesma maneira e escolher as que tiverem melhor ganho.</p>
<p>Nesse exemplo, vamos limitar a profundidade da árvore XGB em 2. Mas o default é permitir até 6 níveis de profundidade.</p>
<p>Nossa árvore XGB final ficou:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb6.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora, vamos podar nossa árvore. Fazemos isso porque pode ser que algum nó tenha o ganho muito baixo e por isso não vale a pena estar na árvore. Para decidir se vamos tirar algum nó e, se sim, qual, vamos escolher um valor que será chamado de <span class="math inline">\(\gamma\)</span> (gamma). Em seguida, calculamos a diferença entre o ganho associado ao nó e <span class="math inline">\(\gamma\)</span>, se essa diferença for negativa, então removemos o nó.</p>
<p><span class="math inline">\(\gamma\)</span> especifica o ganho mínimo necessario para fazer uma divisão. Seu default é 0. Quanto maior, mais conservador é o modelo.</p>
<p>Mesmo quando <span class="math inline">\(\gamma = 0\)</span> isso não previne podas.</p>
<p>Vamos escolher <span class="math inline">\(\gamma = 10\)</span>. Começando sempre dos nós mais profundos para a raiz, vamos avaliar a diferença entre o ganho e<span class="math inline">\(\gamma\)</span>. No nó mais à direita temos que o ganho é 32.7, portanto a diferença é <span class="math inline">\(32.7 - 10 = 22.7\)</span>. Como o resultado é positivo, o nó permanece. No nó à esquerda, a diferença fica <span class="math inline">\(8 - 10 = -2\)</span>, e, como o resultado é negativo, retiramos esse nó. Assim, estamos dizendo que o ganho do nó à esquerda não é bom o suficiente pra justificar essa ramificação. Como o nó à direita permaneceu na árvore, não faz sentido calcular essa diferença para o nó raiz.</p>
<p>Mesmo se o valor da diferença der negativo nos nós de cima, se não removermos o de baixo, o de cima não é removido.</p>
<p>Com isso, nossa árvore XGB ficou:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb7.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Note que se tivéssemos escolhido umNote que se tivéssemos escolhido um<span class="math inline">\(\gamma\)</span> muito alto, por exemplo <span class="math inline">\(\gamma = 570\)</span>, toda árvore seria podada. É preciso cuidado.</p>
<p>Agora vamos voltar ao inicio e reconstruir a árvore agora usando <span class="math inline">\(\lambda = 1\)</span> (Lembra do <span class="math inline">\(\lambda\)</span>? aquele da fórmula do índicador de similaridade!). Para facilitar a vizualização, vamos omitir os cálculos. A nova árvore XGB ficou:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb8.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Podemos notar que quando <span class="math inline">\(\lambda &gt; 0\)</span>, o índice de similaridade é menor. O que significa que se mantivermos o mesmo <span class="math inline">\(\gamma\)</span>, a poda será mais extrema. Por outro lado, deixar <span class="math inline">\(\lambda &gt; 0\)</span> ajuda a previnir sobreajustes.</p>
<p>Agora que temos árvore final, vamos calcular os valores de saída das folhas.</p>
<p><span class="math inline">\(\text{valores de saída} = \frac{\sum \text{soma dos resíduos}}{\text{número de resíduos} + \lambda}\)</span></p>
<p>Repare que essa fórmula é bem parecida com a do índice de similaridade, mas a soma dos resíduos não está ao quadrado.</p>
<p>Repare que, como <span class="math inline">\(\lambda = 0\)</span>, o valor de saida é uma média aritmética simples entre os resíduos. Mas note que se <span class="math inline">\(\lambda &gt; 0\)</span> e a folha tiver apenas uma observação, isso reduzira a sensibilidade dessa observação individual evitando sobreajuste.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb9.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Assim a primeira árvore está completa e, como em Gradient Boosting, fazemos novas predições começando com a predição inicial e somando com o resultado da árvore XGB escalada pela taxa de aprendizado.</p>
<p>O XGBoost chama a taxa de aprendizado de <span class="math inline">\(\epsilon\)</span> (eta) e seu valor default é 0.3, que é o que vamos usar.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb10.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Por exemplo, se a gente pegasse a primeira observação (indivíduo com altura=1.7), seu peso predito seria <span class="math inline">\(predicao \ inicial + \epsilon \ valor\ de\ saida\ da \ árvore\ XGB = 70+0.312=73.6\)</span> que é mais perto do seu peso real (que era 88) do que a predição anterior (70). Assim, com as novas predições, os novos resíduos ficaram:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>nova_pred <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">73.6</span>, <span class="fl">73.6</span>, <span class="fl">66.4</span>, <span class="fl">71.5</span>, <span class="fl">66.4</span>)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>(<span class="at">peso =</span> peso <span class="sc">%&gt;%</span> <span class="fu">mutate</span>( <span class="at">residuos2 =</span> Peso <span class="sc">-</span> nova_pred ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  Altura  Peso residuos residuos2
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1     17    88       18     14.4 
2     16    76        6      2.40
3     15    56      -14    -10.4 
4     18    75        5      3.5 
5     14    60      -10     -6.40</code></pre>
</div>
</div>
<p>Perceba que o novo resíduo é melhor que o anterior (seu valor absoluto é mais próximo de 0). Ou seja, estamos dando pequenos passos na direção correta.</p>
<p>Agora construímos outra árvore XGB da mesma forma, mas para predizer os novos resíduos, Dessa forma obteremos previsões com resíduos menores. E continuamos construíndo árvores XGB até que os resíduos sejam bem pequenos ou até atingir o número de árvores desejado.</p>
</section>
<section id="construindo-um-regressor-com-o-pacote-xgboost" class="level3" data-number="10.6.2">
<h3 data-number="10.6.2" class="anchored" data-anchor-id="construindo-um-regressor-com-o-pacote-xgboost"><span class="header-section-number">10.6.2</span> Construindo um regressor com o pacote xgboost</h3>
<p>Vamos usar a base de dados <span class="red-text">winequality-red</span>. O objetivo dessa base é prever a qualidade do vinho baseado em suas outras variáveis. Mas nós vamos tentar prever o nível alcoólico do vinho.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"winequality-red.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1599 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (12): fixed acidity, volatile acidity, citric acid, residual sugar, chlo...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(wine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>spc_tbl_ [1,599 × 12] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
 $ fixed acidity       : num [1:1599] 7.4 7.8 7.8 11.2 7.4 7.4 7.9 7.3 7.8 7.5 ...
 $ volatile acidity    : num [1:1599] 0.7 0.88 0.76 0.28 0.7 0.66 0.6 0.65 0.58 0.5 ...
 $ citric acid         : num [1:1599] 0 0 0.04 0.56 0 0 0.06 0 0.02 0.36 ...
 $ residual sugar      : num [1:1599] 1.9 2.6 2.3 1.9 1.9 1.8 1.6 1.2 2 6.1 ...
 $ chlorides           : num [1:1599] 0.076 0.098 0.092 0.075 0.076 0.075 0.069 0.065 0.073 0.071 ...
 $ free sulfur dioxide : num [1:1599] 11 25 15 17 11 13 15 15 9 17 ...
 $ total sulfur dioxide: num [1:1599] 34 67 54 60 34 40 59 21 18 102 ...
 $ density             : num [1:1599] 0.998 0.997 0.997 0.998 0.998 ...
 $ pH                  : num [1:1599] 3.51 3.2 3.26 3.16 3.51 3.51 3.3 3.39 3.36 3.35 ...
 $ sulphates           : num [1:1599] 0.56 0.68 0.65 0.58 0.56 0.56 0.46 0.47 0.57 0.8 ...
 $ alcohol             : num [1:1599] 9.4 9.8 9.8 9.8 9.4 9.4 9.4 10 9.5 10.5 ...
 $ quality             : num [1:1599] 5 5 5 6 5 5 5 7 7 5 ...
 - attr(*, "spec")=
  .. cols(
  ..   `fixed acidity` = col_double(),
  ..   `volatile acidity` = col_double(),
  ..   `citric acid` = col_double(),
  ..   `residual sugar` = col_double(),
  ..   chlorides = col_double(),
  ..   `free sulfur dioxide` = col_double(),
  ..   `total sulfur dioxide` = col_double(),
  ..   density = col_double(),
  ..   pH = col_double(),
  ..   sulphates = col_double(),
  ..   alcohol = col_double(),
  ..   quality = col_double()
  .. )
 - attr(*, "problems")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<p>Como sempre, vamos dividir a base em amostra de treino e amostra de teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(wine<span class="sc">$</span>alcohol, <span class="at">p =</span> <span class="fl">0.7</span>, <span class="at">list =</span> F)</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># vendo a classe da base de dados</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(wine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "spec_tbl_df" "tbl_df"      "tbl"         "data.frame" </code></pre>
</div>
</div>
<p>O pacote xgboost só lê matrizes. Então teremos que transformar a base numa matriz. Além disso, teremos que separar a váriavel de interesse das variáveis explicativas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformando a base em matriz</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">=</span> <span class="fu">as.matrix</span>(wine)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(wine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "matrix" "array" </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># separando amostra treino e teste</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>treino       <span class="ot">=</span> wine[noTreino,<span class="sc">-</span><span class="dv">11</span>] <span class="co"># a variável 'alcohol' é a 11ª coluna</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>treino_label <span class="ot">=</span> wine[noTreino, <span class="dv">11</span>]</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>teste       <span class="ot">=</span> wine[<span class="sc">-</span>noTreino,<span class="sc">-</span><span class="dv">11</span>]</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>teste_label <span class="ot">=</span> wine[<span class="sc">-</span>noTreino, <span class="dv">11</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora, podemos usar a função xgboost para criar nosso modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Anexando pacote: 'xgboost'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>O seguinte objeto é mascarado por 'package:dplyr':

    slice</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">xgboost</span>(<span class="at">data =</span> treino, <span class="at">label =</span> treino_label,</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gamma=</span><span class="dv">0</span>, <span class="at">eta=</span><span class="fl">0.3</span>, </span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">objective =</span> <span class="st">"reg:squarederror"</span>, </span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os principais argumentos da função xgboost são:</p>
<ul>
<li>data: recebe a amostra treino apenas com as variáveis explicativas;</li>
<li>label: recebe a variável de interesse;</li>
<li>gamma: ganho mínimo necessário para fazer uma divisão;</li>
<li>eta: taxa de aprendizado;</li>
<li>nrounds: representa o número de iterações;</li>
<li>objective: é o tipo de predição que será feita. Para mais informações, veja nesse site.;</li>
<li>verbose: se for 1, que é o default, o xgboost vai imprimir informações de desempenho a cada iteração. Se for 0, não vai imprimir nada.</li>
</ul>
<p>Para fazer a predição usamos o conhecido predict(). Em seguida, vamos avaliar os resultados do modelo utilizando a função defaultSummary() do pacote caret. Essa função nos retorna os valores do RMSE,<span class="math inline">\(R^2\)</span> e MAE do modelo. Para isso devemos passar como argumento um dataframe onde a primeira coluna são os valores observados dos rótulos do conjunto teste e a segunda coluna são os valores preditos pelo modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo,teste)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculando o RMSE do modelo:</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">defaultSummary</span>(<span class="fu">data.frame</span>(<span class="at">obs =</span> teste_label, <span class="at">pred =</span> predicao))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     RMSE  Rsquared       MAE 
0.5394468 0.7435101 0.3548454 </code></pre>
</div>
</div>
<p>Considerando a escala em que os dados se encontram, o valor do RMSE foi um pouco grande. Em contrapartida podemos considerar os valores do MAE e do <span class="math inline">\(R^2\)</span> como sendo razoáveis para o modelo. Em particular, um <span class="math inline">\(R^2\)</span> de aproximadamente 0,7881 nos indica que o modelo tem um poder de explicação de 78,81%.</p>
</section>
<section id="em-classificação-2" class="level3" data-number="10.6.3">
<h3 data-number="10.6.3" class="anchored" data-anchor-id="em-classificação-2"><span class="header-section-number">10.6.3</span> Em Classificação</h3>
<p>Para entendermos como o XGBoost funciona para problemas de classificação, vamos utilizar a base de dados a seguir. O objetivo é prever se a universidade é pública ou privada baseado nos pedidos para ingresso.</p>
<p>OBS: Assim como comentado anteriormente em regressão, o XGBoost foi projetado para bases de dados grandes, mas para fins didáticos iremos utilizar uma base bem pequena.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>college <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">"SmallCollege.xlsx"</span>)</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>college</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  Private  Apps
  &lt;chr&gt;   &lt;dbl&gt;
1 No       2119
2 Yes      1660
3 Yes      2694
4 No       2785</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Construindo um gráfico para os pedidos para ingresso x tipo da universidade:</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>college <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Apps, <span class="at">y =</span> Private)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">lwd =</span> <span class="dv">5</span>, <span class="fu">aes</span>(<span class="at">colour =</span> Private)) <span class="sc">+</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col =</span> F) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Pedidos para Ingresso x Tipo da Universidade"</span>) <span class="sc">+</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Pedidos para Ingresso"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Universidade Privada"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_point(lwd = 5, aes(colour = Private)): Ignoring unknown
parameters: `linewidth`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as
of ggplot2 3.3.4.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-95-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>O primeiro passo é fazer uma predição inicial. Essa predição pode ser qualquer valor, como por exemplo a probabilidade de observar universidades públicas no conjunto de dados. Por default, essa predição é de 0,5.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/pred_inicial.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Podemos ilustrar essa predição inicial adicionando uma linha horizontal no gráfico que representa as probabilidades de uma universidade ser pública pelo que observamos no conjunto de dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vamos adicionar a coluna "Probabilidade" na base de dados que conterá a probabilidade da</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="co"># universidade ser pública:</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>college<span class="sc">$</span>Probabilidade <span class="ot">=</span> <span class="fu">ifelse</span>(college<span class="sc">$</span>Private <span class="sc">==</span> <span class="st">"Yes"</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico dos pedidos para ingresso x probabilidade da universidade ser pública baseado no</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="co"># conjunto de dados:</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>college <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Apps, <span class="at">y =</span> Probabilidade)) <span class="sc">+</span> </span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_point</span>(<span class="at">lwd =</span> <span class="dv">5</span>, <span class="fu">aes</span>(<span class="at">colour =</span> Private)) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ylab</span>(<span class="st">"Probabilidade da Universidade ser Pública"</span>) <span class="sc">+</span> </span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">type =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ggtitle</span>(<span class="st">"Pedidos para Ingresso x Probabilidade da Universidade ser Pública"</span>) <span class="sc">+</span> </span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">xlab</span>(<span class="st">"Pedidos para Ingresso"</span>) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">col =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_point(lwd = 5, aes(colour = Private)): Ignoring unknown
parameters: `linewidth`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_hline(yintercept = 0.5, type = 2): Ignoring unknown parameters:
`type`</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-96-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Feita a predição inicial, agora vamos calcular os resíduos e verificar quão boa é essa predição.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>college<span class="sc">$</span>Residuos <span class="ot">=</span> college<span class="sc">$</span>Probabilidade<span class="fl">-0.5</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>college</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  Private  Apps Probabilidade Residuos
  &lt;chr&gt;   &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;
1 No       2119             1      0.5
2 Yes      1660             0     -0.5
3 Yes      2694             0     -0.5
4 No       2785             1      0.5</code></pre>
</div>
</div>
<p>O próximo passo é construir uma árvore para predizer os resíduos. Assim como a árvore XGB para regressão, a árvore XGB para classificação se inicia com apenas uma folha que leva todos os resíduos.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Residuos_XGB.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora precisamos calcular o Índice de Similaridade para os resíduos. Porém, como estamos usando XGBoost para classificação, temos uma nova fórmula para ele.</p>
<p><span class="math inline">\(\text{Índice de Similaridade} = \frac{\left( \sum_{i=1}^n\text{Resíduo}_i\right)^2}{\sum_{i=1}^n\left[ \text{Probabilidade Prévia}_i \times (1 - \text{Probabilidade Prévia}_i)\right] + \lambda}\)</span></p>
<p>Veja que o numerador da fórmula para classificação é igual ao da fórmula para regressão. E assim como para regressão, o denominador contém<span class="math inline">\(\lambda\)</span>, o parâmetro de regularização.</p>
<p>Note que, para o nosso exemplo, o numerador do Índice de Similaridade para a folha resultará em 0, pois nós somamos os resíduos antes de elevá-los ao quadrado, o que faz com que eles se cancelem.</p>
<p><span class="math inline">\(\left( \sum_{i=1}^n \text{Resíduo}_i \right)^2 = (0.5 - 0.5 - 0.5 + 0.5)^2 = 0 \implies \text{Índice de Similaridade = 0}\)</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/IS1-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Vamos tentar melhorar o Índice dividindo os resíduos em 2 grupos diferentes. Para isso temos que testar todos os possíveis separadores para os dados e escolher o que tiver o maior ganho. Vamos começar com o primeiro: a média entre os 2 menores valores da variável “<em>Apps</em>”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>ordenados <span class="ot">=</span> <span class="fu">sort</span>(college<span class="sc">$</span>Apps)</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(ordenados[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1889.5</code></pre>
</div>
</div>
<p>Assim, os resíduos que possuem Apps &lt; 1889,5 vão para a esquerda, e os com Apps &gt; 1889,5 vão para a direita.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora vamos calcular o Índice de Similaridade para as duas folhas. Como estamos construindo nossa primeira árvore, a Probabilidade Prévia para todos os resíduos é a predição da folha inicial (0,5). Para simplificar as contas, vamos utilizar o valor padrão de<span class="math inline">\(\lambda\)</span>,<span class="math inline">\(\lambda = 0\)</span>. Contudo, sabemos da regressão que o<span class="math inline">\(\lambda\)</span> reduz o Índice de Similaridade, o que consequentemente diminui o Ganho e assim torna as folhas mais fáceis de serem podadas, o que ajuda a previnir o sobreajuste.</p>
<p><span class="math inline">\(\text{IS}\_{\text{folha da esquerda}} = \frac{(-0.5)^2}{0.5 \times (1-0.5)} = 1\)</span></p>
<p><span class="math inline">\(\text{IS}\_{\text{folha da esquerda}} = \frac{(-0.5 + 0.5 + 0.5)^2}{[0.5 \times (1-0.5)]+[0.5 \times (1-0.5)]+[0.5 \times (1-0.5)]} = 1\)</span></p>
<p>Agora podemos calcular o ganho:</p>
<p><span class="math inline">\(\text{Ganho} = \text{IS}_{\text{folha da esquerda}} + \text{IS}_{\text{folha da direita}} - \text{IS}_{\text{raiz}} = 1 + 0.33 - 0 = 1.33\)</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora vamos realizar os mesmos cálculos para os próximos 2 separadores: a média entre o segundo e o terceiro valor e a média entre o terceiro e o quarto valor da variável “Apps”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Podemos ver que o maior ganho é tanto o da divisão por “Apps &lt; 1889,5?” quanto o da divisão por “Apps &lt; 2739,5?”, que deram exatamente iguais. Assim, podemos usar qualquer um dos 2 para ser a raiz da árvore XGB. Vamos ficar com o último.</p>
<p>O próximo passo agora é ramificar a folha da esquerda para darmos continuidade à nossa árvore. Novamente, vamos limitar a profundidade dela em 2.</p>
<p>A árvore XGB fica, então, da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Assim, terminamos de construir a árvore XGB. Porém, é importante saber que o XGBoost possui uma forma de determinar um número mínimo de resíduos permitido em cada folha da árvore. Ele faz isso calculando o <strong>Cover</strong> das folhas.</p>
<p><span class="math inline">\(\text{Cover} = \sum\_{i = 1}\^n \[\text{Probabilidade Prévia}\_i \times (1 - \text{Probabilidade Prévia}\_i)\]\)</span></p>
<p>Note que o Cover é definido pelo denominador do Índice de Similaridade sem o<span class="math inline">\(\lambda\)</span> . O valor default é de que o Cover seja no mínimo 1, ou seja, se o Cover de uma folha der menor que 1, o XGBoost não permite que ela exista. Se der maior ou igual a 1, ela pode permanecer na árvore.</p>
<p>Calculando o Cover das nossas duas últimas folhas, temos que:</p>
<ul>
<li><p><strong>Cover</strong> da primeira folha: <span class="math inline">\(0.5 \times (1-0.5) = 0.25\)</span></p></li>
<li><p><strong>Cover</strong> da segunda folha: <span class="math inline">\(0.5 \times (1-0.5) + 0.5 \times (1-0.5) = 0.5\)</span></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Como o Cover de ambas as folhas são menores do que 1, o XGBoost não as permite permanecer na árvore. Logo, vamos removê-las. A árvore fica, então, da seguinte forma:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_6.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li><p><strong>Cover</strong> da primeira folha: <span class="math inline">\(0.5 \times (1-0.5) + 0.5 \times (1-0.5) + 0.5 \times (1-0.5) = 0.75\)</span></p></li>
<li><p><strong>Cover</strong> da segunda folha: <span class="math inline">\(0.5 \times (1-0.5) = 0.25\)</span></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_7.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Como o <em>Cover</em> de ambas as folhas também são menores do que 1, o XGBoost também não as permite permanecer na árvore. Assim, só nos resta a raiz. Mas isso também é um problema, pois o XGBoost requer árvores que sejam maiores do que apenas a raiz. Dessa forma, vamos fixar o valor mínimo para o <em>Cover</em> como 0. Assim podemos permanecer com nossa árvore XGB anterior.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_8.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><em>OBS</em>: Quando estamos utilizando XGBoost para regressão usamos a seguinte fórmula para o Índice de Similaridade:</p>
<p><span class="math inline">\(\text{Índice de Similaridade} = \frac{(\sum \text{resíduos})^2}{\text{número de resíduos} + \lambda}\)</span></p>
<p>Logo, o Cover de uma folha é dado por:</p>
<p><span class="math inline">\(\text{Cover} = \text{Número de Resíduos}\)</span></p>
<p>Como o <em>default</em> do Cover é 1, isso significa que podemos ter até 1 resíduo por folha. Em outras palavras, o Cover não tem efeito na construção da árvore. Por conta disso ele não foi utilizado anteriormente em XGBoost para regressão.</p>
<p>Agora vamos entrar na parte de como podar a árvore. Ela é feita exatamente como na regressão, nós podamos com base na diferença entre o <strong>Ganho</strong> associado ao nó e<span class="math inline">\(\gamma\)</span>. Para esse exemplo, vamos fixar <span class="math inline">\(\gamma = 0.5\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_9.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Como a diferença resultou em um número positivo, não podamos o nó. Logo, não precisamos calcular essa diferença para o nó raiz e nossa árvore permanece a mesma. Note que se tivéssemos fixado, por exemplo, <span class="math inline">\(\gamma = 1.5\)</span>, todos os nós seriam podados e nos restaria apenas a predição inicial. É necessário cuidado na escolha do <span class="math inline">\(\gamma\)</span>.</p>
<p>Obtida a árvore final, vamos calcular os valores de saída que as folhas terão.</p>
<p><span class="math inline">\(\text{valores de saída} = \frac{\sum \text{soma dos resíduos}}{\text{número de resíduos} + \lambda}\)</span>.</p>
<p>Note que a fórmula é bem parecida com a do Índice de Similaridade, o que muda é apenas o fato de que o numerador não está ao quadrado. Novamente vamos utilizar o valor padrão para <span class="math inline">\(\lambda\)</span>, 0.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_3-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Agora que construímos nossa primeira árvore podemos realizar predições. Assim como no XGBoost para regressão, o XGBoost para classificação faz novas predições começando com a predição inicial e somando com o resultado da árvore XGB escalado pela taxa de aprendizado. Porém, assim como com o Gradiente Boosting para classificação, precisamos converter a predição inicial, que é uma probabilidade, para log(chances). A fórmula para converter probabilidades para chances é dada por:</p>
<p><span class="math inline">\(log \left( \frac{p}{1-p} \right) = log(chances)\)</span></p>
<p>Então para a predição inicial de 0,5, temos que <span class="math inline">\(log \left( \frac{0.5}{1-0.5} \right) = log(1) = 0\)</span></p>
<p>Agora precisamos adicionar esse valor aos valores de saída da árvore XGB multiplicado pela taxa de aprendizado. Essa taxa é chamada de <span class="math inline">\(\epsilon\)</span> e seu valor padrão é 0,3, o qual iremos usar.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_11.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>OBS: O que as folhas retornarão após esse cálculo serão os log(chances). É preciso, em seguida, converter para probabilidade também.</p>
<p>Fazendo os cálculos da esquerda para a direita, temos que:</p>
<ul>
<li><p>Para a 1ª folha, seu valor de saída fica: <span class="math inline">\(0 + 0.3 \times (-2) = -0.6\)</span></p></li>
<li><p>Para a 2ª folha, seu valor de saída fica: <span class="math inline">\(0 + 0.3 \times 0 = 0\)</span></p></li>
<li><p>Para a 3ª folha, seu valor de saída fica: <span class="math inline">\(0 + 0.3 \times 2 = 0.6\)</span></p></li>
</ul>
<p>Agora para converter esses valores - que são log(chances) - para probabilidade utilizamos a seguinte fórmula:</p>
<p><span class="math inline">\(\text{Probabilidade} = \frac{e^{\text{log(chances)}}}{1+e^{\text{log(chances})}}\)</span></p>
<p>Fazendo os cálculos, então, da esquerda para a direita:</p>
<ul>
<li><p>Para a 1ª folha, seu valor de saída fica: <span class="math inline">\(\frac{e^{-0.6}}{1+e^{-0.6}}\)</span></p></li>
<li><p>Para a 2ª folha, seu valor de saída fica: <span class="math inline">\(\frac{e^{0}}{1+e^{0}}\)</span></p></li>
<li><p>Para a 3ª folha, seu valor de saída fica: <span class="math inline">\(\frac{e^{0.6}}{1+e^{0.6}}\)</span></p></li>
</ul>
<p>Assim, temos as predições da nossa árvore:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_12.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Dessa forma podemos obter novos resíduos utilizando a nova árvore.:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>college<span class="sc">$</span>Residuos2 <span class="ot">=</span> college<span class="sc">$</span>Probabilidade<span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.35</span>,<span class="fl">0.5</span>,<span class="fl">0.65</span>)</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>college</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  Private  Apps Probabilidade Residuos Residuos2
  &lt;chr&gt;   &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 No       2119             1      0.5      0.5 
2 Yes      1660             0     -0.5     -0.35
3 Yes      2694             0     -0.5     -0.5 
4 No       2785             1      0.5      0.35</code></pre>
</div>
</div>
<p>Observe que os novos resíduos são menores (ou iguais) do que os anteriores, o que significa que estamos indo na direção correta. O próximo passo agora é construir uma nova árvore para os novos resíduos. Note que agora as probabilidades preditas são diferentes (antes era de 0,5 para todos os elementos), o que tornará os cálculos do Índice de Similaridade e dos Valores de Saída mais interessantes, por exemplo. Com a nova árvore construída fazemos novas predições que nos darão resíduos menores ainda. Então construímos uma nova árvore baseada nos novos resíduos e repetimos o processo. Fazemos isso até que os resíduos se tornem super pequenos ou se atingirmos o número máximo de árvores escolhido.</p>
<p>Vamos novamente utilizar o pacote xgboost para construirmos um preditor. Dessa vez iremos construir um classificador e para isso usaremos a base de dados Adult, que se encontra presente no seguinte site: https://archive.ics.uci.edu/ml/index.php. Esse site é um repositório de bases de dados reais, o que torna ele interessante para quem está estudando/trabalhando com aprendizado de máquina.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lendo a base de dados como um tibble:</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>renda <span class="ot">=</span> </span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="fu">read.csv</span>(<span class="fu">url</span>(<span class="st">"https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.data"</span>)))</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(renda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [32,560 × 15] (S3: tbl_df/tbl/data.frame)
 $ X39          : int [1:32560] 50 38 53 28 37 49 52 31 42 37 ...
 $ State.gov    : chr [1:32560] " Self-emp-not-inc" " Private" " Private" " Private" ...
 $ X77516       : int [1:32560] 83311 215646 234721 338409 284582 160187 209642 45781 159449 280464 ...
 $ Bachelors    : chr [1:32560] " Bachelors" " HS-grad" " 11th" " Bachelors" ...
 $ X13          : int [1:32560] 13 9 7 13 14 5 9 14 13 10 ...
 $ Never.married: chr [1:32560] " Married-civ-spouse" " Divorced" " Married-civ-spouse" " Married-civ-spouse" ...
 $ Adm.clerical : chr [1:32560] " Exec-managerial" " Handlers-cleaners" " Handlers-cleaners" " Prof-specialty" ...
 $ Not.in.family: chr [1:32560] " Husband" " Not-in-family" " Husband" " Wife" ...
 $ White        : chr [1:32560] " White" " White" " Black" " Black" ...
 $ Male         : chr [1:32560] " Male" " Male" " Male" " Female" ...
 $ X2174        : int [1:32560] 0 0 0 0 0 0 0 14084 5178 0 ...
 $ X0           : int [1:32560] 0 0 0 0 0 0 0 0 0 0 ...
 $ X40          : int [1:32560] 13 40 40 40 40 16 45 50 40 80 ...
 $ United.States: chr [1:32560] " United-States" " United-States" " United-States" " Cuba" ...
 $ X..50K       : chr [1:32560] " &lt;=50K" " &lt;=50K" " &lt;=50K" " &lt;=50K" ...</code></pre>
</div>
</div>
<p>Essa base possui algumas informações sobre 32.560 indivíduos, tais como: estado civil, raça, sexo, país de origem, entre outras, e a variável de interesse “X..50K”, que indica se o indivíduo tem uma renda maior ou menor/igual do que 50.000 U.M. (unidades monetárias) por ano. Mas antes de começarmos a construção do preditor repare que a base de dados possui variáveis com variância quase-zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nearZeroVar</span>(renda, <span class="at">saveMetrics =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               freqRatio percentUnique zeroVar   nzv
X39             1.011261   0.224201474   FALSE FALSE
State.gov       8.931917   0.027641278   FALSE FALSE
X77516          1.000000  66.483415233   FALSE FALSE
Bachelors       1.440269   0.049140049   FALSE FALSE
X13             1.440269   0.049140049   FALSE FALSE
Never.married   1.401985   0.021498771   FALSE FALSE
Adm.clerical    1.010002   0.046068796   FALSE FALSE
Not.in.family   1.588752   0.018427518   FALSE FALSE
White           8.903649   0.015356265   FALSE FALSE
Male            2.022932   0.006142506   FALSE FALSE
X2174          86.020173   0.365479115   FALSE  TRUE
X0            153.668317   0.282555283   FALSE  TRUE
X40             5.397659   0.288697789   FALSE FALSE
United.States  45.363919   0.128992629   FALSE  TRUE
X..50K          3.152532   0.006142506   FALSE FALSE</code></pre>
</div>
</div>
<p>Podemos ver que as variáveis “X2174”, “X0” e “United.States” são as que possuem variância quase-zero, o que significa que elas não trarão muita informação ao modelo, pois possuem os mesmos valores ou mesmas classificações para muitos indivíduos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(renda<span class="sc">$</span>X2174, <span class="at">main =</span> <span class="st">"Histograma da variável X2174"</span>, <span class="at">xlab =</span> <span class="st">"Variável X2174"</span>, </span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Frequência"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-102-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(renda<span class="sc">$</span>X0, <span class="at">main =</span> <span class="st">"Histograma da variável X0"</span>, <span class="at">xlab =</span> <span class="st">"Variável X0"</span>, </span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Frequência"</span>, <span class="at">col =</span> <span class="st">"lightblue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metodos-de-treino-baseados-em-arvore_files/figure-html/unnamed-chunk-103-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabela com as observações da variável "United.States":</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Repare que a grande maioria dos indivíduos (29.169 de 32.560) é proveniente dos Estados Unidos.</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(renda<span class="sc">$</span>United.States)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                          ?                    Cambodia 
                        583                          19 
                     Canada                       China 
                        121                          75 
                   Columbia                        Cuba 
                         59                          95 
         Dominican-Republic                     Ecuador 
                         70                          28 
                El-Salvador                     England 
                        106                          90 
                     France                     Germany 
                         29                         137 
                     Greece                   Guatemala 
                         29                          64 
                      Haiti          Holand-Netherlands 
                         44                           1 
                   Honduras                        Hong 
                         13                          20 
                    Hungary                       India 
                         13                         100 
                       Iran                     Ireland 
                         43                          24 
                      Italy                     Jamaica 
                         73                          81 
                      Japan                        Laos 
                         62                          18 
                     Mexico                   Nicaragua 
                        643                          34 
 Outlying-US(Guam-USVI-etc)                        Peru 
                         14                          31 
                Philippines                      Poland 
                        198                          60 
                   Portugal                 Puerto-Rico 
                         37                         114 
                   Scotland                       South 
                         12                          80 
                     Taiwan                    Thailand 
                         51                          18 
            Trinadad&amp;Tobago               United-States 
                         19                       29169 
                    Vietnam                  Yugoslavia 
                         67                          16 </code></pre>
</div>
</div>
<p>Dessa forma, vamos remover essas variáveis do banco de dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vetor com todas as variáveis com variância quase-zero:</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>nzv <span class="ot">=</span> <span class="fu">nearZeroVar</span>(renda)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Removendo do banco de dados:</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>renda <span class="ot">=</span> renda[, <span class="sc">-</span>nzv]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora precisamos nos atentar a um fator importante da função xgboost: ela só aceita bases de dados com <strong>variáveis numéricas</strong>. Isso é um problema para a nossa base pois ela possui variáveis do tipo factor. O que fazer nesse caso? A resposta para essa pergunta é simples: vamos transformar essas variáveis em variáveis dummies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Criando as variáveis dummies:</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>dummies <span class="ot">=</span> <span class="fu">dummyVars</span>(<span class="sc">~</span> X..<span class="dv">50</span>K <span class="sc">+</span> State.gov <span class="sc">+</span> Bachelors <span class="sc">+</span> Never.married <span class="sc">+</span> Adm.clerical <span class="sc">+</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>                      Not.in.family <span class="sc">+</span> White <span class="sc">+</span> Male, <span class="at">data =</span> renda, <span class="at">fullRank =</span> T)</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicando ao modelo:</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>Dummies <span class="ot">=</span> <span class="fu">predict</span>(dummies, <span class="at">newdata =</span> renda)</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Anexando aos dados:</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>renda <span class="ot">=</span> <span class="fu">cbind</span>(renda, Dummies)</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Excluindo as variáveis categóricas do banco de dados:</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>renda <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">select</span>(renda, <span class="sc">-</span><span class="fu">c</span>(X..<span class="dv">50</span>K, State.gov, Bachelors, Never.married, </span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>                                Adm.clerical, Not.in.family, White, Male))</span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(renda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  X39 X77516 X13 X40 X..50K &gt;50K State.gov Federal-gov State.gov Local-gov
1  50  83311  13  13           0                     0                   0
2  38 215646   9  40           0                     0                   0
3  53 234721   7  40           0                     0                   0
4  28 338409  13  40           0                     0                   0
5  37 284582  14  40           0                     0                   0
6  49 160187   5  16           0                     0                   0
  State.gov Never-worked State.gov Private State.gov Self-emp-inc
1                      0                 0                      0
2                      0                 1                      0
3                      0                 1                      0
4                      0                 1                      0
5                      0                 1                      0
6                      0                 1                      0
  State.gov Self-emp-not-inc State.gov State-gov State.gov Without-pay
1                          1                   0                     0
2                          0                   0                     0
3                          0                   0                     0
4                          0                   0                     0
5                          0                   0                     0
6                          0                   0                     0
  Bachelors 11th Bachelors 12th Bachelors 1st-4th Bachelors 5th-6th
1              0              0                 0                 0
2              0              0                 0                 0
3              1              0                 0                 0
4              0              0                 0                 0
5              0              0                 0                 0
6              0              0                 0                 0
  Bachelors 7th-8th Bachelors 9th Bachelors Assoc-acdm Bachelors Assoc-voc
1                 0             0                    0                   0
2                 0             0                    0                   0
3                 0             0                    0                   0
4                 0             0                    0                   0
5                 0             0                    0                   0
6                 0             1                    0                   0
  Bachelors Bachelors Bachelors Doctorate Bachelors HS-grad Bachelors Masters
1                   1                   0                 0                 0
2                   0                   0                 1                 0
3                   0                   0                 0                 0
4                   1                   0                 0                 0
5                   0                   0                 0                 1
6                   0                   0                 0                 0
  Bachelors Preschool Bachelors Prof-school Bachelors Some-college
1                   0                     0                      0
2                   0                     0                      0
3                   0                     0                      0
4                   0                     0                      0
5                   0                     0                      0
6                   0                     0                      0
  Never.married Married-AF-spouse Never.married Married-civ-spouse
1                               0                                1
2                               0                                0
3                               0                                1
4                               0                                1
5                               0                                1
6                               0                                0
  Never.married Married-spouse-absent Never.married Never-married
1                                   0                           0
2                                   0                           0
3                                   0                           0
4                                   0                           0
5                                   0                           0
6                                   1                           0
  Never.married Separated Never.married Widowed Adm.clerical Adm-clerical
1                       0                     0                         0
2                       0                     0                         0
3                       0                     0                         0
4                       0                     0                         0
5                       0                     0                         0
6                       0                     0                         0
  Adm.clerical Armed-Forces Adm.clerical Craft-repair
1                         0                         0
2                         0                         0
3                         0                         0
4                         0                         0
5                         0                         0
6                         0                         0
  Adm.clerical Exec-managerial Adm.clerical Farming-fishing
1                            1                            0
2                            0                            0
3                            0                            0
4                            0                            0
5                            1                            0
6                            0                            0
  Adm.clerical Handlers-cleaners Adm.clerical Machine-op-inspct
1                              0                              0
2                              1                              0
3                              1                              0
4                              0                              0
5                              0                              0
6                              0                              0
  Adm.clerical Other-service Adm.clerical Priv-house-serv
1                          0                            0
2                          0                            0
3                          0                            0
4                          0                            0
5                          0                            0
6                          1                            0
  Adm.clerical Prof-specialty Adm.clerical Protective-serv Adm.clerical Sales
1                           0                            0                  0
2                           0                            0                  0
3                           0                            0                  0
4                           1                            0                  0
5                           0                            0                  0
6                           0                            0                  0
  Adm.clerical Tech-support Adm.clerical Transport-moving
1                         0                             0
2                         0                             0
3                         0                             0
4                         0                             0
5                         0                             0
6                         0                             0
  Not.in.family Not-in-family Not.in.family Other-relative
1                           0                            0
2                           1                            0
3                           0                            0
4                           0                            0
5                           0                            0
6                           1                            0
  Not.in.family Own-child Not.in.family Unmarried Not.in.family Wife
1                       0                       0                  0
2                       0                       0                  0
3                       0                       0                  0
4                       0                       0                  1
5                       0                       0                  1
6                       0                       0                  0
  White Asian-Pac-Islander White Black White Other White White Male Male
1                        0           0           0           1         1
2                        0           0           0           1         1
3                        0           1           0           0         1
4                        0           1           0           0         0
5                        0           0           0           1         0
6                        0           1           0           0         0</code></pre>
</div>
</div>
<p>Note que agora todas as nossas variáveis são numéricas e, portanto, a base está pronta para construirmos o preditor. Como sempre, vamos começar dividindo-a em amostra treino e amostra teste.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>noTreino <span class="ot">=</span> <span class="fu">createDataPartition</span>(renda<span class="sc">$</span><span class="st">`</span><span class="at">X..50K &gt;50K</span><span class="st">`</span>, <span class="at">p =</span> <span class="fl">0.75</span>, <span class="at">list =</span> F)</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Lembre-se que temos que transformar a base em uma matriz:</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>renda <span class="ot">=</span> <span class="fu">as.matrix</span>(renda)</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>treino <span class="ot">=</span> renda[noTreino, <span class="sc">-</span><span class="dv">5</span>]</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>treino_label <span class="ot">=</span> renda[noTreino, <span class="dv">5</span>]</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>teste <span class="ot">=</span> renda[<span class="sc">-</span>noTreino, <span class="sc">-</span><span class="dv">5</span>]</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>teste_label <span class="ot">=</span> renda[<span class="sc">-</span>noTreino, <span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora vamos usar a função xgboost() para criar o modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">=</span> <span class="fu">xgboost</span>(<span class="at">data =</span> treino, <span class="at">label =</span> treino_label, <span class="at">lambda =</span> <span class="dv">1</span>, <span class="at">gamma =</span> <span class="dv">0</span>, <span class="at">eta =</span> <span class="fl">0.3</span>,</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nrounds =</span> <span class="dv">500</span>, <span class="at">objective =</span> <span class="st">"binary:logistic"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">max_depth =</span> <span class="dv">3</span>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fazendo a predição:</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>predicao <span class="ot">=</span> <span class="fu">predict</span>(modelo, teste)</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicao)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.846276224 0.001679021 0.220495090 0.008715384 0.843290508 0.730734646</code></pre>
</div>
</div>
<p>O modelo retorna probabilidades, então devemos criar um classificador. Vamos criar um bem simples, da seguinte forma:</p>
<ul>
<li>Probabilidade acima de 0,5: consideramos que a renda do indivíduo é maior do que 50.000;</li>
<li>Probabilidade abaixo de 0,5: consideramos que a renda do indivíduo é menor ou igual a 50.000.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>classificador <span class="ot">=</span> <span class="fu">as.numeric</span>(predicao<span class="sc">&gt;=</span><span class="fl">0.5</span>)</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Utilizando a matriz de confusão para avaliar o modelo:</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(<span class="at">data =</span> <span class="fu">as.factor</span>(classificador), <span class="at">reference =</span> <span class="fu">as.factor</span>(teste_label), <span class="at">positive =</span> <span class="st">"1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction    0    1
         0 5654  794
         1  564 1128
                                          
               Accuracy : 0.8332          
                 95% CI : (0.8249, 0.8412)
    No Information Rate : 0.7639          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.5176          
                                          
 Mcnemar's Test P-Value : 5.159e-10       
                                          
            Sensitivity : 0.5869          
            Specificity : 0.9093          
         Pos Pred Value : 0.6667          
         Neg Pred Value : 0.8769          
             Prevalence : 0.2361          
         Detection Rate : 0.1386          
   Detection Prevalence : 0.2079          
      Balanced Accuracy : 0.7481          
                                          
       'Positive' Class : 1               
                                          </code></pre>
</div>
</div>
<p>Podemos usar o pacote DiagrammeR para visualizarmos as árvores construídas pelo modelo. Para isso basta utilizarmos a função xgb.plot.tree() e no argumento trees escolhermos a(s) árvore(s) desejada(s).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizando a segunda árvore construída:</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.tree</span>(<span class="at">model =</span> modelo, <span class="at">trees =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-11b3a28f1a6bf786f600" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-11b3a28f1a6bf786f600">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       rankdir = \"LR\"]\n\nnode [color = \"DimGray\",\n      style = \"filled\",\n      fontname = \"Helvetica\"]\n\nedge [color = \"DimGray\",\n     arrowsize = \"1.5\",\n     arrowhead = \"vee\",\n     fontname = \"Helvetica\"]\n\n  \"1\" [label = \"Tree 2\nNever.married Married-civ-spouse\nCover: 5385.37695\nGain: 1306.82288\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"2\" [label = \"X13\nCover: 2675.50879\nGain: 151.504639\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"3\" [label = \"X13\nCover: 2709.86816\nGain: 483.430145\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"4\" [label = \"X39\nCover: 2075.73779\nGain: 20.545166\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"5\" [label = \"X40\nCover: 599.770874\nGain: 89.4872589\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"6\" [label = \"Adm.clerical Exec-managerial\nCover: 1900.92212\nGain: 138.218872\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"7\" [label = \"X40\nCover: 808.946045\nGain: 51.0574951\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"8\" [label = \"Leaf\nCover: 1156.00098\nValue: -0.392639577\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"9\" [label = \"Leaf\nCover: 919.736877\nValue: -0.330458313\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"10\" [label = \"Leaf\nCover: 389.132843\nValue: -0.278612733\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"11\" [label = \"Leaf\nCover: 210.638062\nValue: -0.0357727222\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"12\" [label = \"Leaf\nCover: 1689.30823\nValue: -0.142572567\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"13\" [label = \"Leaf\nCover: 211.613892\nValue: 0.114208564\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"14\" [label = \"Leaf\nCover: 412.193054\nValue: 0.0885483027\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"15\" [label = \"Leaf\nCover: 396.753021\nValue: 0.239560291\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n\"1\"->\"2\" [label = \"< 0.5\", style = \"bold\"] \n\"2\"->\"4\" [label = \"< 12.5\", style = \"bold\"] \n\"3\"->\"6\" [label = \"< 12.5\", style = \"bold\"] \n\"4\"->\"8\" [label = \"< 33.5\", style = \"bold\"] \n\"5\"->\"10\" [label = \"< 43.5\", style = \"bold\"] \n\"6\"->\"12\" [label = \"< 0.5\", style = \"bold\"] \n\"7\"->\"14\" [label = \"< 41.5\", style = \"bold\"] \n\"1\"->\"3\" [style = \"bold\", style = \"solid\"] \n\"2\"->\"5\" [style = \"solid\", style = \"solid\"] \n\"3\"->\"7\" [style = \"solid\", style = \"solid\"] \n\"4\"->\"9\" [style = \"solid\", style = \"solid\"] \n\"5\"->\"11\" [style = \"solid\", style = \"solid\"] \n\"6\"->\"13\" [style = \"solid\", style = \"solid\"] \n\"7\"->\"15\" [style = \"solid\", style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pre-processamento.html" class="pagination-link" aria-label="Pré-processamento">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Pré-processamento</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./outros-metodos.html" class="pagination-link" aria-label="Outros Métodos de Aprendizado de Máquina">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Outros Métodos de Aprendizado de Máquina</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Criação: Maqueise Pinheiro e Thaís Machado. <br> Orientação: Douglas Rodrigues (UFF) e Karina Yaginuma (UFF). <br> Colaboradores: Gabriel Miranda, Thiago Augusto, Luana Moreno e Guilherme Ceacero.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/CienciaDeDadosUFF/cienciadedadosuff2.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>